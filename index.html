<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taipei Travel Log</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Apple Style) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: 'rgba(255, 255, 255, 0.7)',
                            cardDark: 'rgba(28, 28, 30, 0.7)',
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            separator: '#C6C6C8'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'bounce-ios': 'bounceIOS 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceIOS: {
                            '0%': { transform: 'scale(0.95)' },
                            '50%': { transform: 'scale(1.02)' },
                            '100%': { transform: 'scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Global Styles */
        :root {
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            background-color: #F2F2F7;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* Noise Texture Overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
        }

        /* Neo-Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }

        .glass-card:active {
            transform: scale(0.98);
        }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Intro Animation */
        #intro-screen {
            transition: opacity 0.8s ease-out, visibility 0.8s;
        }

        /* Dynamic Gradients based on time */
        .theme-morning { background: linear-gradient(180deg, #E0F7FA 0%, #F2F2F7 100%); }
        .theme-day { background: linear-gradient(180deg, #FFFDE7 0%, #F2F2F7 100%); }
        .theme-sunset { background: linear-gradient(180deg, #FFECB3 0%, #F2F2F7 100%); }
        .theme-night { background: linear-gradient(180deg, #1a237e 0%, #000000 100%); color: white; }
    </style>
</head>
<body class="text-gray-800 relative theme-morning transition-colors duration-1000" id="main-body">

    <!-- Noise Overlay -->
    <div class="noise-overlay"></div>

    <!-- Cinematic Intro -->
    <div id="intro-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center">
        <div class="text-center space-y-4 animate-slide-up">
            <i class="fa-solid fa-plane-departure text-5xl text-blue-500 mb-4"></i>
            <h1 class="text-3xl font-bold tracking-tight text-gray-900">Taipei<br><span class="text-gray-400 font-medium text-xl">Travel Log</span></h1>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="max-w-7xl mx-auto px-4 py-6 pb-24 opacity-0 transition-opacity duration-1000">
        
        <!-- Hero Header (Parallax) -->
        <header class="relative w-full h-64 rounded-3xl overflow-hidden mb-6 shadow-lg group">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Taipei_Skyline_2022.06.29.jpg/2560px-Taipei_Skyline_2022.06.29.jpg" 
                 class="absolute inset-0 w-full h-[120%] object-cover transition-transform duration-700 parallax-bg"
                 alt="Taipei Skyline">
            <div class="absolute inset-0 bg-black/20 backdrop-blur-[2px]"></div>
            <div class="absolute bottom-6 left-6 text-white z-10">
                <p class="text-sm font-medium opacity-80 mb-1">3박 4일 여행</p>
                <h2 class="text-3xl font-bold tracking-tight">대만, 타이베이</h2>
                <div id="live-weather-badge" class="inline-flex items-center gap-2 mt-2 px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-xs">
                    <i class="fa-solid fa-spinner fa-spin"></i> 날씨 로딩 중...
                </div>
            </div>
        </header>

        <!-- Floating Action Buttons (Bottom Right) -->
        <div class="fixed bottom-6 right-6 z-40 flex flex-col gap-3">
            <button onclick="toggleCurrency()" class="w-12 h-12 rounded-full bg-white/80 backdrop-blur-xl shadow-lg flex items-center justify-center text-green-600 hover:scale-110 transition-transform active:scale-90 border border-white/40">
                <i class="fa-solid fa-coins"></i>
            </button>
            <button onclick="scrollToTop()" class="w-12 h-12 rounded-full bg-blue-500/90 backdrop-blur-xl shadow-lg flex items-center justify-center text-white hover:scale-110 transition-transform active:scale-90 border border-white/20">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>

        <!-- Bento Grid: Info & Tools -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            
            <!-- Weather Card (Now Clickable) -->
            <div class="glass-card p-5 rounded-3xl md:col-span-2 relative overflow-hidden group cursor-pointer transition-transform active:scale-95" onclick="openWeatherDetail()">
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200">현재 날씨</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400" id="weather-location">타이베이</p>
                    </div>
                    <div class="text-right">
                        <span id="weather-temp" class="text-4xl font-bold tracking-tighter">-°</span>
                    </div>
                </div>
                <div class="mt-6 flex items-center gap-6 relative z-10">
                    <i id="weather-icon" class="fa-solid fa-cloud text-5xl text-blue-400 drop-shadow-md"></i>
                    <div class="space-y-1">
                        <p id="weather-desc" class="font-medium text-gray-700">데이터 불러오는 중...</p>
                        <p id="weather-wind" class="text-xs text-gray-500"><i class="fa-solid fa-wind mr-1"></i> - km/h</p>
                    </div>
                </div>
                
                <!-- Click Hint Badge -->
                <div class="absolute bottom-4 right-4 bg-white/30 backdrop-blur-sm px-3 py-1 rounded-full text-[10px] text-gray-600 font-medium shadow-sm flex items-center gap-1">
                    <i class="fa-solid fa-chart-simple"></i> 상세 보기
                </div>

                <!-- Decorative Circle -->
                <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-400/20 rounded-full blur-3xl group-hover:bg-blue-400/30 transition-all duration-700"></div>
            </div>

            <!-- Quick Exchange Rate Card -->
            <div class="glass-card p-5 rounded-3xl relative overflow-hidden cursor-pointer active:scale-95 transition-transform" onclick="toggleCurrency()">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold text-gray-700">실시간 환율</h3>
                    <div class="bg-green-100 text-green-700 p-1.5 rounded-full text-xs">
                        <i class="fa-solid fa-arrow-trend-up"></i>
                    </div>
                </div>
                <div class="flex flex-col justify-center h-full pb-6">
                    <div class="flex items-baseline justify-between">
                        <span class="text-2xl font-bold text-gray-800">100 TWD</span>
                        <span class="text-sm text-gray-400">≈</span>
                    </div>
                    <div class="text-3xl font-bold text-blue-600 mt-1">
                        <span id="exchange-preview">4,250</span> KRW
                    </div>
                    <p class="text-xs text-gray-400 mt-2 text-right">눌러서 계산하기</p>
                </div>
            </div>
        </div>

        <!-- Day Tabs (Sticky) -->
        <div class="sticky top-4 z-30 mb-6">
            <div class="bg-white/70 backdrop-blur-xl rounded-full p-1.5 flex justify-between shadow-lg border border-white/40 overflow-x-auto no-scrollbar" id="day-tabs">
                <!-- Generated by JS -->
            </div>
        </div>

        <!-- Timeline Content -->
        <div id="timeline-container" class="space-y-4 min-h-[50vh]">
            <!-- Generated by JS -->
        </div>

        <!-- Footer -->
        <footer class="mt-12 text-center pb-8">
            <p class="text-xs text-gray-400 font-medium">Designed with <i class="fa-solid fa-heart text-red-400 mx-1"></i> for Taiwan Trip</p>
            <p class="text-[10px] text-gray-300 mt-2 uppercase tracking-widest">iOS 17 Style Concept</p>
        </footer>

    </div>

    <!-- Currency Converter Modal (Overlay) -->
    <div id="currency-modal" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-md hidden flex items-end sm:items-center justify-center transition-opacity duration-300 opacity-0" onclick="closeCurrency(event)">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full sm:w-96 p-6 shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300" id="currency-panel" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 sm:hidden"></div>
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">환율 계산기</h3>
                <button onclick="toggleCurrency()" class="w-8 h-8 bg-gray-100 rounded-full text-gray-500 hover:bg-gray-200"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <!-- Input Area -->
            <div class="space-y-2 mb-6">
                <!-- TWD Input -->
                <div id="field-twd" class="bg-blue-50 border-2 border-blue-500 p-4 rounded-2xl transition-colors cursor-pointer" onclick="setCurrencyMode('TWD')">
                    <p class="text-xs text-gray-500 mb-1 flex justify-between">
                        <span>대만 달러 (TWD)</span>
                        <span class="text-blue-500 font-bold text-[10px] opacity-0 active-indicator">입력 중</span>
                    </p>
                    <input type="text" id="twd-input" class="w-full bg-transparent text-3xl font-bold text-gray-800 text-right outline-none" value="0" readonly>
                </div>

                <!-- Swap Button -->
                <div class="flex justify-center -my-3 relative z-10">
                    <button onclick="swapCurrencyMode()" class="w-10 h-10 rounded-full bg-white border border-gray-200 shadow-md flex items-center justify-center text-blue-500 hover:scale-110 transition-transform">
                        <i class="fa-solid fa-arrow-right-arrow-left text-sm"></i>
                    </button>
                </div>

                <!-- KRW Input -->
                <div id="field-krw" class="bg-gray-50 border-2 border-transparent p-4 rounded-2xl transition-colors cursor-pointer" onclick="setCurrencyMode('KRW')">
                    <p class="text-xs text-gray-500 mb-1 flex justify-between">
                        <span>대한민국 원 (KRW)</span>
                        <span class="text-blue-500 font-bold text-[10px] opacity-0 active-indicator">입력 중</span>
                    </p>
                    <input type="text" id="krw-input" class="w-full bg-transparent text-3xl font-bold text-gray-800 text-right outline-none" value="0" readonly>
                </div>
            </div>

            <div class="text-right mb-4">
                <p class="text-xs text-gray-400">적용 환율: 1 TWD ≈ <span id="current-rate-display">46.94</span> KRW</p>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-3 gap-3">
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="1">1</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="2">2</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="3">3</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="4">4</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="5">5</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="6">6</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="7">7</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="8">8</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="9">9</button>
                <button class="h-14 rounded-xl bg-gray-100 border border-gray-200 text-lg font-medium text-red-500 active:bg-red-50 shadow-sm" onclick="clearCalc()">C</button>
                <button class="h-14 rounded-xl bg-white border border-gray-200 text-xl font-medium active:bg-gray-100 shadow-sm btn-numpad" data-val="0">0</button>
                <button class="h-14 rounded-xl bg-gray-100 border border-gray-200 text-lg font-medium active:bg-gray-200 shadow-sm" onclick="backspaceCalc()"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>
    </div>

    <!-- Weather Detail Modal (New) -->
    <div id="weather-modal" class="fixed inset-0 z-[80] bg-black/50 backdrop-blur-md hidden items-center justify-center opacity-0 transition-opacity duration-300" onclick="closeWeatherDetail()">
        <div class="bg-white/90 rounded-3xl w-11/12 max-w-lg shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative" id="weather-content" onclick="event.stopPropagation()">
            
            <!-- Header -->
            <div class="p-6 pb-2 relative">
                <button onclick="closeWeatherDetail()" class="absolute top-4 right-4 w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
                <h2 class="text-2xl font-bold text-gray-900 mb-1">Taipei Weather</h2>
                <p class="text-sm text-gray-500" id="modal-weather-summary">Loading details...</p>
            </div>

            <!-- Hourly Forecast (Horizontal Scroll) -->
            <div class="px-6 py-4 border-b border-gray-100">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3"><i class="fa-solid fa-clock mr-1"></i> 24시간 예보</h4>
                <div class="flex overflow-x-auto gap-4 pb-2 no-scrollbar" id="hourly-forecast-container">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Daily Forecast (Vertical List) -->
            <div class="px-6 py-4 bg-gray-50/50">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3"><i class="fa-solid fa-calendar-days mr-1"></i> 주간 예보</h4>
                <div class="space-y-3" id="daily-forecast-container">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[70] bg-black/60 backdrop-blur-lg hidden items-center justify-center opacity-0 transition-opacity duration-300" onclick="closeDetail()">
        <div class="glass-card bg-white/90 w-11/12 max-w-md rounded-3xl overflow-hidden shadow-2xl transform scale-95 transition-transform duration-300" id="detail-content" onclick="event.stopPropagation()">
            <!-- Content Injected via JS -->
        </div>
    </div>

    <script>
        // --- 1. DATA (Immutable) ---
        const travelData = { "Day1": [ { "place": "김해국제공항 (에어부산 카운터 D동, Gate5 2층)", "map": "金海國際機場", "arrive": "08:50", "stay": "2h", "depart": "-", "category": "출국", "memo": "수속 및 대기", "move": null }, { "place": "에어부산 BX793 (PUS 10:50 - TPE 12:25)", "arrive": "10:50", "depart": "12:25", "category": "비행", "stay": "2h 35m", "map": "桃園國際機場", "move": "비행" }, { "place": "타오위안 국제공항", "map": "桃園國際機場", "arrive": "12:25", "stay": "-", "depart": "-", "category": "입국", "memo": "입국심사, MRT 탑승", "move": "MRT 40m" }, { "place": "타이베이 메인 스테이션", "map": "台北車站", "category": "교통", "memo": "숙소 인근 도착", "move": "도보 10m" }, { "place": "유산동 우육면", "map": "山東牛肉麵 西門店", "category": "음식점", "memo": "중식", "move": "도보 10m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "15:00", "stay": "30m", "depart": "15:30", "category": "숙소", "memo": "체크인 및 휴식", "move": "도보 10m" }, { "place": "삼형매 빙수", "map": "三兄妹豆花冰品", "arrive": "15:40", "stay": "50m", "depart": "16:30", "category": "디저트", "memo": "빙수 및 휴식", "move": "전철 20m" }, { "place": "국립 중정 기념당", "map": "國立中正紀念堂", "arrive": "16:50", "stay": "1h 10m", "depart": "18:00", "category": "관광명소", "move": "전철 30m" }, { "place": "스린 야시장", "map": "士林夜市", "arrive": "18:30", "stay": "3h", "depart": "21:30", "category": "야시장", "memo": "석식 및 구경", "move": "전철 30m" }, { "place": "스위엔 시먼점", "map": "師園鹽酥雞（西門店）", "arrive": "22:00", "category": "음식점", "memo": "야식", "move": "도보 5m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "취침" } ], "Day2": [ { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "조식 후 준비", "move": "도보 5m" }, { "place": "시먼역 (4번 출구)", "map": "捷運西門站 4號出口", "arrive": "10:45", "category": "교통", "memo": "가이드 미팅", "move": "버스 이동" }, { "place": "예류 지질공원", "map": "野柳地質公園", "arrive": "12:30", "stay": "1h 10m", "depart": "13:40", "category": "관광명소" }, { "place": "스펀 폭포", "map": "十分瀑布", "arrive": "14:40", "stay": "50m", "depart": "15:30", "category": "관광명소" }, { "place": "스펀 라오제", "map": "十分老街", "arrive": "15:40", "stay": "50m", "depart": "16:30", "category": "관광명소", "memo": "천등 체험" }, { "place": "지우펀", "map": "九份老街", "arrive": "17:10", "stay": "2h", "depart": "19:10", "category": "관광명소", "memo": "석식 포함", "move": "버스 이동" }, { "place": "시먼역", "arrive": "20:20", "map": "捷運西門站 4號出口", "category": "교통", "memo": "투어 종료", "move": "도보 5m" }, { "place": "행복당 시먼점", "map": "幸福堂 西門店", "category": "디저트", "memo": "디저트", "move": "도보 10m" }, { "place": "180도씨 지파이", "map": "180度C雞排", "category": "음식점", "memo": "야식", "move": "도보 15m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "귀가 및 휴식" } ], "Day3": [ { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "출발 준비", "move": "도보 5m" }, { "place": "시먼딩", "map": "西門町", "arrive": "11:00", "stay": "1h 30m", "depart": "12:30", "category": "쇼핑" }, { "place": "천천리", "map": "108台北市萬華區漢中街32巷1號", "arrive": "12:30", "stay": "1h", "depart": "13:30", "category": "음식점", "move": "버스 10m" }, { "place": "까르푸 꾸이린점", "map": "家樂福 桂林店", "arrive": "13:40", "stay": "1h 30m", "depart": "15:10", "category": "쇼핑", "move": "도보 10m" }, { "place": "세인트 피터 누가 크래커", "map": "聖比德 西門店", "arrive": "15:20", "stay": "20m", "depart": "15:40", "category": "쇼핑", "move": "도보 5m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "15:45", "stay": "30m", "depart": "16:15", "category": "숙소", "memo": "물품 정리", "move": "전철 30m" }, { "place": "딘타이펑 타이베이 101점", "map": "鼎泰豐 台北101店", "arrive": "16:45", "stay": "1h", "depart": "18:45", "category": "음식점", "memo": "대기 후 석식", "move": "101몰 내부 이동" }, { "place": "타이베이 101 전망대", "map": "台北101 觀景台", "arrive": "19:00", "stay": "2h", "depart": "21:00", "category": "관광명소", "move": "버스 20m" }, { "place": "레인보우 브리지", "map": "彩虹橋", "arrive": "21:20", "stay": "30m", "depart": "21:50", "category": "관광명소", "move": "전철 30m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "22:20", "category": "숙소" } ], "Day4": [ { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "조식 후 체크아웃", "move": "전철 30m" }, { "place": "국립 대만대학교", "map": "國立臺灣大學", "arrive": "10:00", "stay": "1h 30m", "depart": "11:30", "category": "관광명소", "memo": "캠퍼스 산책", "move": "전철 30m" }, { "place": "용산사", "map": "龍山寺", "arrive": "12:00", "stay": "1h", "depart": "13:00", "category": "사찰", "move": "도보 10m" }, { "place": "삼미 식당", "map": "三味食堂", "arrive": "13:10", "stay": "1h", "depart": "14:10", "category": "음식점", "move": "버스 10m" }, { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "14:20", "stay": "10m", "depart": "14:30", "category": "숙소", "memo": "짐 찾기", "move": "전철 10m" }, { "place": "타이베이 메인 스테이션", "map": "台北車站", "arrive": "14:40", "category": "교통", "memo": "공항 MRT 대기", "move": "MRT 40m" }, { "place": "타오위안 국제공항 (터미널 2)", "map": "桃園國際機場 第二航廈", "arrive": "15:30", "stay": "2h 10m", "category": "출국", "memo": "에어부산 출국 수속" } ] };

        // --- 2. APP STATE ---
        let currentDay = 'Day1';
        let EXCHANGE_RATE = 46.94; // Google Search Default
        let activeCurrency = 'TWD'; // 'TWD' or 'KRW'
        let weatherDataStore = null; // Store full weather data

        // --- 3. INIT & ANIMATION ---
        window.onload = () => {
            // Intro Animation Sequence
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0';
                document.getElementById('intro-screen').style.visibility = 'hidden';
                document.getElementById('app').style.opacity = '1';
                
                initWeather();
                initExchangeRate(); // Fetch Real-time Rate
                renderTabs();
                renderTimeline('Day1');
                setThemeByTime();
            }, 2000);
        };

        // Parallax Effect
        window.addEventListener('scroll', () => {
            const scrolled = window.scrollY;
            const parallaxBg = document.querySelector('.parallax-bg');
            if(parallaxBg) {
                parallaxBg.style.transform = `translateY(${scrolled * 0.4}px)`;
            }
        });

        // --- 4. WEATHER (Open-Meteo) ---
        async function initWeather() {
            const lat = 25.0330; // Taipei
            const lon = 121.5654;
            // Fetch Hourly and Daily data as well
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                weatherDataStore = data; // Store for Modal
                
                updateWeatherUI(data.current_weather);
            } catch (e) {
                console.error("Weather fetch failed", e);
                document.getElementById('weather-desc').innerText = "오프라인 모드";
            }
        }

        function getWmoInfo(code) {
             // WMO Code Mapping (Korean Translation)
            let iconClass = "fa-cloud";
            let desc = "흐림";
            let colorClass = "text-gray-400";
            
            if(code === 0) { iconClass = "fa-sun"; desc = "맑음"; colorClass = "text-yellow-400"; }
            else if(code <= 3) { iconClass = "fa-cloud-sun"; desc = "구름 조금"; colorClass = "text-orange-300"; }
            else if(code <= 48) { iconClass = "fa-smog"; desc = "안개"; colorClass = "text-gray-400"; }
            else if(code <= 67) { iconClass = "fa-cloud-rain"; desc = "비"; colorClass = "text-blue-400"; }
            else if(code <= 82) { iconClass = "fa-cloud-showers-heavy"; desc = "폭우"; colorClass = "text-blue-600"; }
            else if(code <= 99) { iconClass = "fa-bolt"; desc = "뇌우"; colorClass = "text-yellow-600"; }

            return { icon: iconClass, desc: desc, color: colorClass };
        }

        function updateWeatherUI(weather) {
            const temp = Math.round(weather.temperature);
            const wind = weather.windspeed;
            const info = getWmoInfo(weather.weathercode);

            document.getElementById('weather-temp').innerText = `${temp}°`;
            document.getElementById('weather-wind').innerHTML = `<i class="fa-solid fa-wind mr-1"></i> ${wind} km/h`;
            document.getElementById('live-weather-badge').innerHTML = `<i class="fa-solid fa-temperature-half"></i> ${temp}°C 타이베이`;

            const iconEl = document.getElementById('weather-icon');
            iconEl.className = `fa-solid ${info.icon} text-5xl drop-shadow-md ${info.color}`;
            document.getElementById('weather-desc').innerText = info.desc;
        }

        // --- 4.2 WEATHER MODAL FUNCTIONS ---
        function openWeatherDetail() {
            if (!weatherDataStore) return;
            
            const modal = document.getElementById('weather-modal');
            const content = document.getElementById('weather-content');
            const summary = document.getElementById('modal-weather-summary');
            
            const current = weatherDataStore.current_weather;
            const info = getWmoInfo(current.weathercode);
            summary.innerText = `현재: ${Math.round(current.temperature)}°C, ${info.desc}`;

            renderHourlyForecast();
            renderDailyForecast();

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeWeatherDetail() {
            const modal = document.getElementById('weather-modal');
            const content = document.getElementById('weather-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            content.classList.remove('scale-100');

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function renderHourlyForecast() {
            const container = document.getElementById('hourly-forecast-container');
            const hourly = weatherDataStore.hourly;
            
            // Get current hour index (rough approx)
            const now = new Date();
            const currentHourStr = now.toISOString().slice(0, 13); // YYYY-MM-DDTHH
            let startIndex = hourly.time.findIndex(t => t.startsWith(currentHourStr));
            if (startIndex === -1) startIndex = 0;

            let html = '';
            // Show next 24 hours
            for(let i = startIndex; i < startIndex + 24 && i < hourly.time.length; i++) {
                const timeStr = hourly.time[i]; // "2023-05-20T14:00"
                const date = new Date(timeStr);
                const hourLabel = date.getHours() + '시';
                const temp = Math.round(hourly.temperature_2m[i]);
                const code = hourly.weathercode[i];
                const info = getWmoInfo(code);

                html += `
                    <div class="flex flex-col items-center min-w-[60px] p-2 bg-gray-50 rounded-2xl">
                        <span class="text-xs text-gray-500 mb-2">${i === startIndex ? '지금' : hourLabel}</span>
                        <i class="fa-solid ${info.icon} text-xl mb-2 ${info.color}"></i>
                        <span class="text-sm font-bold text-gray-800">${temp}°</span>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function renderDailyForecast() {
            const container = document.getElementById('daily-forecast-container');
            const daily = weatherDataStore.daily;
            
            let html = '';
            // Show next 7 days
            for(let i = 0; i < daily.time.length; i++) {
                const timeStr = daily.time[i];
                const date = new Date(timeStr);
                const dayLabel = new Intl.DateTimeFormat('ko-KR', { weekday: 'short' }).format(date); // 월, 화...
                const min = Math.round(daily.temperature_2m_min[i]);
                const max = Math.round(daily.temperature_2m_max[i]);
                const code = daily.weathercode[i];
                const info = getWmoInfo(code);

                html += `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded-xl transition-colors">
                        <span class="w-10 font-medium text-gray-600">${i === 0 ? '오늘' : dayLabel}</span>
                        <div class="flex items-center gap-2 flex-1 justify-center">
                            <i class="fa-solid ${info.icon} ${info.color}"></i>
                            <span class="text-xs text-gray-400">${info.desc}</span>
                        </div>
                        <div class="w-24 flex justify-end gap-3 text-sm">
                            <span class="text-gray-400">${min}°</span>
                            <div class="w-16 h-1.5 bg-gray-200 rounded-full relative mt-2 overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-blue-300 to-orange-300 opacity-50"></div>
                            </div>
                            <span class="font-bold text-gray-800">${max}°</span>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        // --- 4.5 EXCHANGE RATE API ---
        async function initExchangeRate() {
            try {
                // Free API for TWD base
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                const data = await response.json();
                if(data && data.rates && data.rates.KRW) {
                    EXCHANGE_RATE = data.rates.KRW;
                    console.log("Live Exchange Rate Fetched:", EXCHANGE_RATE);
                }
            } catch (e) {
                console.warn("Exchange rate fetch failed, using default:", EXCHANGE_RATE);
            }
            
            // Update Display
            document.getElementById('current-rate-display').innerText = EXCHANGE_RATE.toFixed(2);
            
            // Update Preview Card
            const previewAmount = 100;
            const previewResult = Math.round(previewAmount * EXCHANGE_RATE);
            document.getElementById('exchange-preview').innerText = previewResult.toLocaleString();
        }

        function setThemeByTime() {
            const hour = new Date().getHours();
            const body = document.getElementById('main-body');
            
            body.classList.remove('theme-morning', 'theme-day', 'theme-sunset', 'theme-night');

            if (hour >= 6 && hour < 11) body.classList.add('theme-morning');
            else if (hour >= 11 && hour < 17) body.classList.add('theme-day');
            else if (hour >= 17 && hour < 20) body.classList.add('theme-sunset');
            else body.classList.add('theme-night');
        }

        // --- 5. RENDER FUNCTIONS ---
        function renderTabs() {
            const container = document.getElementById('day-tabs');
            const days = Object.keys(travelData);
            
            container.innerHTML = days.map(day => `
                <button onclick="switchDay('${day}')" 
                    class="px-6 py-2 rounded-full text-sm font-semibold transition-all duration-300 ${currentDay === day ? 'bg-white text-black shadow-md scale-105' : 'text-gray-500 hover:bg-white/40'}">
                    ${day}
                </button>
            `).join('');
        }

        function switchDay(day) {
            currentDay = day;
            renderTabs();
            
            const timeline = document.getElementById('timeline-container');
            // Transition Effect
            timeline.style.opacity = '0';
            timeline.style.transform = 'translateY(10px)';
            
            setTimeout(() => {
                renderTimeline(day);
                timeline.style.opacity = '1';
                timeline.style.transform = 'translateY(0)';
            }, 300);
        }

        function getCategoryIcon(category) {
            if(category.includes("비행") || category.includes("공항") || category.includes("출국")) return "fa-plane";
            if(category.includes("교통") || category.includes("이동")) return "fa-bus";
            if(category.includes("음식") || category.includes("중식") || category.includes("석식")) return "fa-utensils";
            if(category.includes("디저트")) return "fa-ice-cream";
            if(category.includes("숙소") || category.includes("호텔")) return "fa-bed";
            if(category.includes("관광") || category.includes("공원")) return "fa-camera";
            if(category.includes("쇼핑")) return "fa-bag-shopping";
            return "fa-location-dot";
        }

        function renderTimeline(day) {
            const container = document.getElementById('timeline-container');
            const items = travelData[day];
            
            let html = '';
            
            items.forEach((item, index) => {
                const delay = index * 100; // Staggered animation
                const icon = getCategoryIcon(item.category);
                const timeDisplay = item.arrive ? item.arrive : (item.category === '숙소' && !item.depart ? 'Night' : '--:--');

                html += `
                <div class="group flex gap-4 animate-slide-up cursor-pointer" style="animation-delay: ${delay}ms" onclick='openDetail(${JSON.stringify(item)})'>
                    <!-- Time Column -->
                    <div class="flex flex-col items-end min-w-[60px] pt-4">
                        <span class="text-sm font-bold text-gray-800 dark:text-gray-200">${timeDisplay}</span>
                        ${item.stay ? `<span class="text-[10px] text-gray-400 mt-1 bg-white/50 px-1.5 rounded-md">${item.stay}</span>` : ''}
                    </div>

                    <!-- Line & Dot -->
                    <div class="relative flex flex-col items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 border-2 border-white z-10 shadow-sm group-hover:scale-125 transition-transform duration-300"></div>
                        ${index !== items.length - 1 ? '<div class="w-0.5 h-full bg-gray-300/50 absolute top-3 -bottom-4"></div>' : ''}
                    </div>

                    <!-- Content Card -->
                    <div class="flex-1 pb-6">
                        <div class="glass-card p-4 rounded-2xl hover:bg-white/80 transition-colors relative overflow-hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="inline-block text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded-md mb-1">${item.category}</span>
                                    <h4 class="font-bold text-gray-800 leading-tight">${item.place}</h4>
                                    ${item.memo ? `<p class="text-xs text-gray-500 mt-1 line-clamp-1"><i class="fa-regular fa-note-sticky mr-1"></i>${item.memo}</p>` : ''}
                                </div>
                                <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                            </div>
                            
                            ${item.move ? `
                            <div class="mt-3 pt-3 border-t border-gray-100 flex items-center text-xs text-gray-500">
                                <i class="fa-solid fa-person-walking mr-1.5"></i> ${item.move}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html;
        }

        // --- 6. MODAL LOGIC ---
        function openDetail(item) {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            const icon = getCategoryIcon(item.category);
            const googleMapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.map)}`;

            content.innerHTML = `
                <div class="relative">
                    <!-- Map Header Placeholder -->
                    <div class="h-32 bg-gradient-to-r from-blue-400 to-blue-600 w-full relative">
                        <div class="absolute inset-0 bg-black/10"></div>
                        <div class="absolute -bottom-8 left-6 w-16 h-16 rounded-2xl bg-white shadow-lg flex items-center justify-center text-2xl text-blue-500">
                            <i class="fa-solid ${icon}"></i>
                        </div>
                        <button onclick="closeDetail()" class="absolute top-4 right-4 w-8 h-8 bg-black/20 backdrop-blur-md rounded-full text-white flex items-center justify-center hover:bg-black/40">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="pt-10 px-6 pb-6">
                        <span class="text-xs font-bold text-blue-500 tracking-wider uppercase">${item.category}</span>
                        <h2 class="text-2xl font-bold text-gray-900 mt-1 mb-1">${item.place}</h2>
                        <p class="text-sm text-gray-500 flex items-center gap-1 mb-6">
                            <i class="fa-solid fa-location-dot text-red-400"></i> ${item.map}
                        </p>

                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <span class="text-xs text-gray-400 block mb-1">Arrive</span>
                                <span class="font-semibold text-gray-800">${item.arrive || '-'}</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl">
                                <span class="text-xs text-gray-400 block mb-1">Duration</span>
                                <span class="font-semibold text-gray-800">${item.stay || '-'}</span>
                            </div>
                        </div>

                        ${item.memo ? `
                        <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-xl mb-6">
                            <h5 class="text-sm font-bold text-yellow-800 mb-1"><i class="fa-solid fa-circle-info mr-1"></i> Memo</h5>
                            <p class="text-sm text-gray-700 leading-relaxed">${item.memo}</p>
                        </div>
                        ` : ''}

                        ${item.move ? `
                        <div class="flex items-center gap-3 text-sm text-gray-600 mb-6 bg-gray-50 p-3 rounded-xl">
                            <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm text-blue-500">
                                <i class="fa-solid fa-route"></i>
                            </div>
                            <span>Next move: <strong>${item.move}</strong></span>
                        </div>
                        ` : ''}

                        <a href="${googleMapUrl}" target="_blank" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl text-center shadow-lg shadow-blue-500/30 transition-transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="fa-brands fa-google"></i> Open in Google Maps
                        </a>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Small timeout for transition
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeDetail() {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            content.classList.remove('scale-100');

            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        // --- 7. CURRENCY CALCULATOR ---
        function toggleCurrency() {
            const modal = document.getElementById('currency-modal');
            const panel = document.getElementById('currency-panel');
            
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Init state
                updateCalcUI();
                
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    panel.classList.remove('translate-y-full');
                });
            } else {
                closeCurrency();
            }
        }

        function closeCurrency(e) {
            const modal = document.getElementById('currency-modal');
            const panel = document.getElementById('currency-panel');
            
            modal.classList.add('opacity-0');
            panel.classList.add('translate-y-full');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Bi-directional Logic
        let currentInputVal = "0";
        
        function setCurrencyMode(mode) {
            activeCurrency = mode; // 'TWD' or 'KRW'
            
            const targetVal = mode === 'TWD' ? document.getElementById('twd-input').value : document.getElementById('krw-input').value;
            currentInputVal = targetVal.replace(/,/g, '');
            if(currentInputVal === '0') currentInputVal = "";

            updateCalcUI();
        }

        function swapCurrencyMode() {
            setCurrencyMode(activeCurrency === 'TWD' ? 'KRW' : 'TWD');
        }

        function updateCalcUI() {
            const twdField = document.getElementById('field-twd');
            const krwField = document.getElementById('field-krw');
            const twdIndicator = twdField.querySelector('.active-indicator');
            const krwIndicator = krwField.querySelector('.active-indicator');

            // Reset Styles
            twdField.className = "p-4 rounded-2xl transition-colors cursor-pointer border-2";
            krwField.className = "p-4 rounded-2xl transition-colors cursor-pointer border-2";
            twdIndicator.style.opacity = '0';
            krwIndicator.style.opacity = '0';

            // Apply Active Style
            if (activeCurrency === 'TWD') {
                twdField.classList.add('bg-blue-50', 'border-blue-500');
                krwField.classList.add('bg-gray-50', 'border-transparent');
                twdIndicator.style.opacity = '1';
            } else {
                krwField.classList.add('bg-blue-50', 'border-blue-500');
                twdField.classList.add('bg-gray-50', 'border-transparent');
                krwIndicator.style.opacity = '1';
            }
        }

        // Keypad Event Listeners
        document.querySelectorAll('.btn-numpad').forEach(btn => {
            btn.addEventListener('click', () => {
                const val = btn.getAttribute('data-val');
                if(currentInputVal === "0") currentInputVal = val;
                else if(currentInputVal.length < 9) currentInputVal += val; // Limit length
                calculateAndRender();
            });
        });

        function clearCalc() {
            currentInputVal = "0";
            calculateAndRender();
        }

        function backspaceCalc() {
            if(currentInputVal.length > 1) currentInputVal = currentInputVal.slice(0, -1);
            else currentInputVal = "0";
            calculateAndRender();
        }

        function calculateAndRender() {
            const twdInput = document.getElementById('twd-input');
            const krwInput = document.getElementById('krw-input');
            
            const inputNum = Number(currentInputVal);

            if (activeCurrency === 'TWD') {
                // TWD -> KRW
                twdInput.value = inputNum.toLocaleString();
                const krwVal = Math.round(inputNum * EXCHANGE_RATE);
                krwInput.value = krwVal.toLocaleString();
            } else {
                // KRW -> TWD
                krwInput.value = inputNum.toLocaleString();
                const twdVal = Math.round(inputNum / EXCHANGE_RATE); // Reverse calc
                twdInput.value = twdVal.toLocaleString();
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

    </script>
</body>
</html>
