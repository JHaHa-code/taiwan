<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taipei Trip Planner & AI Assistant (OpenAI)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJ8u2I9QJk4s5d+yJ+t2x+h8m6l/g/w/Q+O/3/iXmB+iJ2y+t2x+h8m6l/g/w/Q+O/3/iXmB+iJ2y/w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar hiding for the day selector */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Custom font family */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        /* Keyframe for fade-in effect */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }
        .animate-fade-in-up {
            animation: fade-in 0.6s ease-out;
        }
    </style>
</head>
<body class="bg-[#F5F5F7]">

    <div id="app" class="min-h-screen font-sans text-gray-900 pb-32 select-none selection:bg-blue-100">
        <!-- Header -->
        <header id="main-header" class="fixed top-0 w-full z-50 transition-all duration-300 bg-transparent pt-6 pb-2">
            <div class="max-w-md mx-auto px-6 flex justify-between items-center">
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="bg-gray-900 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md tracking-wider">TAIWAN</span>
                        <span class="text-[11px] font-bold text-gray-400 uppercase tracking-widest">3ë°• 4ì¼</span>
                    </div>
                    <h1 class="text-2xl font-black tracking-tighter text-gray-900">Taipei Trip</h1>
                </div>
                <button class="w-10 h-10 rounded-full bg-gray-100 p-0.5 shadow-sm active:scale-95 transition-transform">
                    <div class="w-full h-full rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-[10px]">
                        MY
                    </div>
                </button>
            </div>
            <!-- Day Selector (visible only in schedule tab) -->
            <div id="day-selector-container" class="max-w-md mx-auto px-4 mt-4 overflow-x-auto no-scrollbar">
                <div id="day-selector" class="flex gap-2 pb-2 px-1">
                    <!-- Day buttons will be rendered here -->
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="max-w-md mx-auto px-5 pt-36 animate-fade-in-up">
            <!-- Content will be rendered here -->
        </main>

        <!-- Bottom Nav -->
        <nav class="fixed bottom-8 left-1/2 transform -translate-x-1/2 w-[90%] max-w-[380px] bg-white/90 backdrop-blur-xl rounded-[28px] shadow-[0_8px_32px_rgba(0,0,0,0.12)] border border-white/50 z-50 p-1.5">
            <div id="bottom-nav-buttons" class="flex justify-between items-center px-2">
                <!-- Nav buttons will be rendered here -->
            </div>
        </nav>
    </div>

    <script>
        // ==========================================
        // [ì„¤ì •] OpenAI API í‚¤ë¥¼ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.
        // ==========================================
        const OPENAI_API_KEY = "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"; // ë”°ì˜´í‘œ("") ì•ˆì— í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: "sk-..."
        
        // --- GLOBAL STATE ---
        let activeTab = "schedule";
        let currentDay = "Day1";
        let messages = [
            {
                role: "bot",
                text: "ì•ˆë…•í•˜ì„¸ìš”! ëŒ€ë§Œ ì—¬í–‰ì˜ ë“ ë“ í•œ ë¹„ì„œì…ë‹ˆë‹¤. ğŸ‡¹ğŸ‡¼ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”! (ë§›ì§‘, ë‚ ì”¨, êµí†µ, ì¤‘êµ­ì–´ í‘œí˜„ ë“±)",
            },
        ];
        let chatInput = "";
        let chatLoading = false;
        const RATE = 42.8; // Fixed Exchange Rate

        // --- DATA (Schedule) ---
        const scheduleData = {
            Day1: [
                { place: "ê¹€í•´êµ­ì œê³µí•­", map: "é‡‘æµ·åœ‹éš›æ©Ÿå ´", arrive: "08:50", stay: "2h", category: "ì¶œêµ­", memo: "ìˆ˜ì† ë° ëŒ€ê¸°", move: null },
                { place: "ì—ì–´ë¶€ì‚° BX793", arrive: "10:50", depart: "12:25", category: "ë¹„í–‰", stay: "2h 35m", map: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", move: "ë¹„í–‰", flightUrl: "https://kr.trip.com/flights/status-bx793/" },
                { place: "íƒ€ì˜¤ìœ„ì•ˆ êµ­ì œê³µí•­", map: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", arrive: "12:25", category: "ì…êµ­", memo: "ì…êµ­ì‹¬ì‚¬, MRT íƒ‘ìŠ¹", move: "ê³µí•­ MRT (40m)" },
                { place: "íƒ€ì´ë² ì´ ë©”ì¸ ìŠ¤í…Œì´ì…˜", map: "å°åŒ—è»Šç«™", category: "êµí†µ", memo: "ìˆ™ì†Œ ì¸ê·¼ ë„ì°©", move: "ë„ë³´ (10m)" },
                { place: "ìœ ì‚°ë™ ìš°ìœ¡ë©´", map: "å±±æ±ç‰›è‚‰éºµ è¥¿é–€åº—", category: "ìŒì‹ì ", memo: "ì¤‘ì‹", move: "ë„ë³´ (10m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", arrive: "15:00", stay: "30m", depart: "15:30", category: "ìˆ™ì†Œ", memo: "ì²´í¬ì¸ ë° íœ´ì‹", move: "ë„ë³´ (10m)" },
                { place: "ì‚¼í˜•ë§¤ ë¹™ìˆ˜", map: "ä¸‰å…„å¦¹è±†èŠ±å†°å“", arrive: "15:40", stay: "50m", depart: "16:30", category: "ë””ì €íŠ¸", memo: "ë¹™ìˆ˜ ë° íœ´ì‹", move: "ì „ì²  (20m)" },
                { place: "êµ­ë¦½ ì¤‘ì • ê¸°ë…ë‹¹", map: "åœ‹ç«‹ä¸­æ­£ç´€å¿µå ‚", arrive: "16:50", stay: "1h 10m", depart: "18:00", category: "ê´€ê´‘ëª…ì†Œ", memo: "ê´€ëŒ", move: "ì „ì²  (30m)" },
                { place: "ìŠ¤ë¦° ì•¼ì‹œì¥", map: "å£«æ—å¤œå¸‚", arrive: "18:30", stay: "3h", depart: "21:30", category: "ì•¼ì‹œì¥", memo: "ì„ì‹ ë° êµ¬ê²½", move: "ì „ì²  (30m)" },
                { place: "ìŠ¤ìœ„ì—” ì‹œë¨¼ ì ", map: "å¸«åœ’é¹½é…¥é›ï¼ˆè¥¿é–€åº—ï¼‰", arrive: "22:00", category: "ìŒì‹ì ", memo: "ì•¼ì‹", move: "ë„ë³´ (5m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", category: "ìˆ™ì†Œ", memo: "ì·¨ì¹¨" },
            ],
            Day2: [
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", category: "ìˆ™ì†Œ", memo: "ì¡°ì‹ í›„ ì¤€ë¹„", move: "ë„ë³´ (5m)" },
                { place: "ì‹œë¨¼ì—­ (4ë²ˆ ì¶œêµ¬ ì•)", map: "æ·é‹è¥¿é–€ç«™ 4è™Ÿå‡ºå£", arrive: "10:45", category: "êµí†µ", memo: "íˆ¬ì–´ ë¯¸íŒ…", move: "ë²„ìŠ¤ ì´ë™" },
                { place: "ì˜ˆë¥˜ ì§€ì§ˆê³µì›", map: "é‡æŸ³åœ°è³ªå…¬åœ’", arrive: "12:30", stay: "1h 10m", depart: "13:40", category: "ê´€ê´‘ëª…ì†Œ", memo: "ê´€ê´‘" },
                { place: "ìŠ¤í€ í­í¬", map: "ååˆ†ç€‘å¸ƒ", arrive: "14:40", stay: "50m", depart: "15:30", category: "ê´€ê´‘ëª…ì†Œ", memo: "ê´€ëŒ" },
                { place: "ìŠ¤í€ ë¼ì˜¤ì œ", map: "ååˆ†è€è¡—", arrive: "15:40", stay: "50m", depart: "16:30", category: "ê´€ê´‘ëª…ì†Œ", memo: "ì²œë“± ì²´í—˜" },
                { place: "ì§€ìš°í€", map: "ä¹ä»½è€è¡—", arrive: "17:10", stay: "2h", depart: "19:10", category: "ê´€ê´‘ëª…ì†Œ", memo: "ì„ì‹ í¬í•¨", move: "ë²„ìŠ¤ ì´ë™" },
                { place: "ì‹œë¨¼ì—­", arrive: "20:20", map: "æ·é‹è¥¿é–€ç«™ 4è™Ÿå‡ºå£", category: "êµí†µ", memo: "íˆ¬ì–´ ì¢…ë£Œ", move: "ë„ë³´ (5m)" },
                { place: "í–‰ë³µë‹¹ ì‹œë¨¼ì ", map: "å¹¸ç¦å ‚ è¥¿é–€åº—", category: "ë””ì €íŠ¸", memo: "ë””ì €íŠ¸", move: "ë„ë³´ (10m)" },
                { place: "180ë„ì”¨ ì§€íŒŒì´", map: "180åº¦Cé›æ’", category: "ìŒì‹ì ", memo: "ì•¼ì‹", move: "ë„ë³´ (15m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", category: "ìˆ™ì†Œ", memo: "ê·€ê°€" },
            ],
            Day3: [
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", category: "ìˆ™ì†Œ", memo: "ì¡°ì‹ í›„ ì¶œë°œ", move: "ë„ë³´ (5m)" },
                { place: "ì‹œë¨¼ë”©", map: "è¥¿é–€ç”º", arrive: "11:00", stay: "1h 30m", depart: "12:30", category: "ì‡¼í•‘", memo: "ê±°ë¦¬ êµ¬ê²½" },
                { place: "ì²œì²œë¦¬", map: "108å°åŒ—å¸‚è¬è¯å€æ¼¢ä¸­è¡—32å··1è™Ÿ", arrive: "12:30", stay: "1h", depart: "13:30", category: "ìŒì‹ì ", memo: "ì¤‘ì‹", move: "ë²„ìŠ¤ (10m)" },
                { place: "ê¹Œë¥´í‘¸ ê¾¸ì´ë¦°ì ", map: "å®¶æ¨‚ç¦ æ¡‚æ—åº—", arrive: "13:40", stay: "1h 30m", depart: "15:10", category: "ì‡¼í•‘", memo: "ì‡¼í•‘", move: "ë„ë³´ (10m)" },
                { place: "ì„¸ì¸íŠ¸ í”¼í„°", map: "è–æ¯”å¾· è¥¿é–€åº—", arrive: "15:20", stay: "20m", depart: "15:40", category: "ë””ì €íŠ¸", memo: "ì‡¼í•‘", move: "ë„ë³´ (5m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", arrive: "15:45", stay: "30m", depart: "16:15", category: "ìˆ™ì†Œ", memo: "ë¬¼í’ˆ ì •ë¦¬", move: "ì „ì²  (30m)" },
                { place: "ë”˜íƒ€ì´í‘ 101ì ", map: "é¼æ³°è± å°åŒ—101åº—", arrive: "16:45", stay: "1h", depart: "18:45", category: "ìŒì‹ì ", memo: "ì„ì‹", move: "ë„ë³´" },
                { place: "íƒ€ì´ë² ì´ 101 ì „ë§ëŒ€", map: "å°åŒ—101 è§€æ™¯å°", arrive: "19:00", stay: "2h", depart: "21:00", category: "ê´€ê´‘ëª…ì†Œ", memo: "ì•¼ê²½", move: "ë²„ìŠ¤ (20m)" },
                { place: "ë ˆì¸ë³´ìš° ë¸Œë¦¬ì§€", map: "å½©è™¹æ©‹", arrive: "21:20", stay: "30m", depart: "21:50", category: "ê´€ê´‘ëª…ì†Œ", memo: "ì•¼ê²½", move: "ì „ì²  (30m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", arrive: "22:20", category: "ìˆ™ì†Œ", memo: "ê·€ê°€" },
            ],
            Day4: [
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", category: "ìˆ™ì†Œ", memo: "ì²´í¬ì•„ì›ƒ", move: "ì „ì²  (30m)" },
                { place: "êµ­ë¦½ ëŒ€ë§ŒëŒ€í•™êµ", map: "åœ‹ç«‹è‡ºç£å¤§å­¸", arrive: "10:00", stay: "1h 30m", depart: "11:30", category: "ê´€ê´‘ëª…ì†Œ", memo: "ì‚°ì±…", move: "ì „ì²  (30m)" },
                { place: "ìš©ì‚°ì‚¬", map: "é¾å±±å¯º", arrive: "12:00", stay: "1h", depart: "13:00", category: "ì‚¬ì°°", memo: "êµ¬ê²½", move: "ë„ë³´ (10m)" },
                { place: "ì‚¼ë¯¸ ì‹ë‹¹", map: "ä¸‰å‘³é£Ÿå ‚", arrive: "13:10", stay: "1h", depart: "14:10", category: "ìŒì‹ì ", memo: "ì¤‘ì‹", move: "ë²„ìŠ¤ (10m)" },
                { place: "í˜¸í…” ë¯¸ë“œíƒ€ìš´ ë¦¬ì²˜ë“œìŠ¨", map: "å¾·ç«‹èŠé…’åº—", arrive: "14:20", stay: "10m", depart: "14:30", category: "ìˆ™ì†Œ", memo: "ì§ ì°¾ê¸°", move: "ì „ì²  (10m)" },
                { place: "íƒ€ì´ë² ì´ ë©”ì¸ ìŠ¤í…Œì´ì…˜", map: "å°åŒ—è»Šç«™", arrive: "14:40", category: "êµí†µ", memo: "ê³µí•­ì„  ëŒ€ê¸°", move: "ê³µí•­ MRT (40m)" },
                { place: "íƒ€ì˜¤ìœ„ì•ˆ êµ­ì œê³µí•­ T2", map: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ ç¬¬äºŒèˆªå»ˆ", arrive: "15:30", stay: "2h 10m", category: "ì¶œêµ­", memo: "ì¶œêµ­ ìˆ˜ì†", move: "ë¹„í–‰" },
                { place: "ì—ì–´ë¶€ì‚° BX792", map: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´", arrive: "17:40", depart: "21:00", stay: "2h 20m", category: "ë¹„í–‰", memo: "ë¶€ì‚° ë„ì°©", flightUrl: "https://kr.trip.com/flights/status-bx792/" },
            ],
        };

        // --- UTILS (Icon & Color Mapping) ---

        const getCategoryIconHtml = (category) => {
            let iconClass;
            switch (category) {
                case "ë¹„í–‰": case "ì¶œêµ­": case "ì…êµ­": iconClass = "fa-plane"; break;
                case "ìˆ™ì†Œ": iconClass = "fa-bed"; break;
                case "ìŒì‹ì ": iconClass = "fa-utensils"; break;
                case "ë””ì €íŠ¸": case "ì¹´í˜": iconClass = "fa-mug-saucer"; break;
                case "ê´€ê´‘ëª…ì†Œ": case "ì•¼ì‹œì¥": case "ì‚¬ì°°": iconClass = "fa-camera"; break;
                case "ì‡¼í•‘": iconClass = "fa-bag-shopping"; break;
                case "êµí†µ": iconClass = "fa-train"; break;
                default: iconClass = "fa-location-dot";
            }
            return `<i class="fa-solid ${iconClass} text-xl"></i>`;
        };

        const getCategoryColor = (category) => {
            switch (category) {
                case "ë¹„í–‰": case "ì¶œêµ­": case "ì…êµ­": return "bg-sky-50 text-sky-600 border-sky-100";
                case "ìˆ™ì†Œ": return "bg-indigo-50 text-indigo-600 border-indigo-100";
                case "ìŒì‹ì ": case "ë””ì €íŠ¸": return "bg-orange-50 text-orange-600 border-orange-100";
                case "ê´€ê´‘ëª…ì†Œ": case "ì•¼ì‹œì¥": return "bg-rose-50 text-rose-600 border-rose-100";
                case "ì‡¼í•‘": return "bg-emerald-50 text-emerald-600 border-emerald-100";
                case "êµí†µ": return "bg-slate-50 text-slate-600 border-slate-100";
                default: return "bg-gray-50 text-gray-600 border-gray-100";
            }
        };

        const getWeatherIconHtml = (code, sizeClass = "w-20 h-20") => {
            let iconClass, colorClass;
            if (code === 0) { iconClass = "fa-sun"; colorClass = "text-amber-400"; }
            else if (code >= 1 && code <= 3) { iconClass = "fa-cloud"; colorClass = "text-gray-400"; }
            else if (code >= 51 && code <= 67) { iconClass = "fa-cloud-showers-heavy"; colorClass = "text-blue-400"; }
            else if (code >= 80 && code <= 99) { iconClass = "fa-cloud-bolt"; colorClass = "text-purple-500"; }
            else { iconClass = "fa-cloud"; colorClass = "text-gray-400"; }
            return `<i class="fa-solid ${iconClass} ${colorClass} ${sizeClass}"></i>`;
        };

        const getWeatherDesc = (code) => {
            if (code === 0) return "ë§‘ìŒ";
            if (code >= 1 && code <= 3) return "íë¦¼";
            if (code >= 51 && code <= 67) return "ë¹„";
            if (code >= 80 && code <= 99) return "ë‡Œìš°";
            return "ë³´í†µ";
        };

        // --- API INTEGRATION (OpenAI) ---
        
        async function getAIResponse(userMessage) {
            if (!OPENAI_API_KEY || OPENAI_API_KEY.length < 10) {
                return "âš ï¸ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½”ë“œì˜ `OPENAI_API_KEY` ë³€ìˆ˜ì— í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            }

            const systemPrompt = "ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ìœ ì¾Œí•œ ëŒ€ë§Œ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ëŒ€í•´ í•œêµ­ì–´ë¡œ ë‹µë³€í•´ ì£¼ì„¸ìš”. ë‹µë³€ì€ ê°„ê²°í•˜ê³  ì‹¤ìš©ì ì¸ ì •ë³´ë¥¼ ìœ„ì£¼ë¡œ ì œê³µí•˜ì„¸ìš”.";

            const apiMessages = [
                { role: "system", content: systemPrompt },
                { role: "user", content: userMessage }
            ];
            
            const payload = {
                model: "gpt-3.5-turbo",
                messages: apiMessages,
                temperature: 0.7,
                max_tokens: 500,
            };

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error("OpenAI API Error:", response.status, errorData);
                    
                    if (response.status === 401) return "âŒ API í‚¤ ì˜¤ë¥˜: í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.";
                    if (response.status === 429) return "â³ ìš”ì²­ ì œí•œ ì´ˆê³¼: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                    return `âš ï¸ API ì˜¤ë¥˜ ë°œìƒ (${response.status}).`;
                }

                const data = await response.json();
                return data.choices?.[0]?.message?.content?.trim() || "ì£„ì†¡í•©ë‹ˆë‹¤. ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";

            } catch (error) {
                console.error("Network Error:", error);
                if (error.message.includes("Failed to fetch")) {
                    return "ğŸš« ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨ë¨ (CORS ì˜¤ë¥˜)\n\në¸Œë¼ìš°ì € ë³´ì•ˆìƒ HTML íŒŒì¼ì—ì„œ ì§ì ‘ API í˜¸ì¶œì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[í•´ê²°ë°©ë²•]\n1. ë¡œì»¬ í…ŒìŠ¤íŠ¸ë¼ë©´ 'Allow CORS' ê°™ì€ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì‚¬ìš©í•˜ì„¸ìš”.\n2. í˜¹ì€ í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•´ì•¼ í•©ë‹ˆë‹¤.";
                }
                return "ì£„ì†¡í•©ë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }


        // --- RENDER FUNCTIONS ---

        const renderItineraryCard = (item, isLast, index) => {
            const searchQuery = item.map;
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
            const categoryClasses = getCategoryColor(item.category);
            const itemDepart = item.depart || (item.stay && item.stay.includes("h") ? "-" : "");

            return `
                <div class="relative pl-4 pb-2 group animate-fade-in" style="animation-delay: ${index * 50}ms;">
                    ${!isLast ? `<div class="absolute left-[24px] top-[60px] bottom-[-12px] w-[2px] bg-gray-100 z-0"></div>` : ''}
                    <div class="relative z-10 flex gap-5 mb-6">
                        <div class="flex flex-col items-center min-w-[52px] mt-1">
                            <div class="w-[52px] h-[52px] rounded-2xl flex items-center justify-center shadow-sm border border-white z-10 transition-transform duration-300 group-hover:scale-110 ${categoryClasses}">
                                ${getCategoryIconHtml(item.category)}
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="bg-white p-5 rounded-[24px] shadow-[0_2px_10px_-3px_rgba(0,0,0,0.03)] border border-gray-100/80 hover:shadow-[0_8px_25px_-5px_rgba(0,0,0,0.08)] transition-all duration-300 active:scale-[0.98]">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="flex items-baseline gap-1.5">
                                        ${item.arrive ? `
                                            <span class="font-mono text-gray-800 font-bold text-lg tracking-tight">${item.arrive}</span>
                                            ${itemDepart ? `
                                                <div class="flex items-center text-gray-300 text-xs font-medium ml-1">
                                                    <i class="fa-solid fa-chevron-right mx-0.5 text-[10px]"></i>
                                                    <span class="text-gray-400 font-mono">${itemDepart}</span>
                                                </div>
                                            ` : ''}
                                        ` : `<span class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded-md border border-gray-100">SCHEDULE</span>`}
                                    </div>
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-wide border ${categoryClasses.replace("bg-", "bg-opacity-20 bg-").replace("text-", "text-").replace("border-", "border-")}">
                                        ${item.category}
                                    </span>
                                </div>
                                <h4 class="text-[19px] font-bold text-gray-900 leading-snug mb-2.5 truncate tracking-tight">${item.place}</h4>
                                <div class="space-y-2.5">
                                    ${item.stay ? `<div class="flex items-center text-xs text-gray-400 font-medium bg-gray-50 inline-flex px-2.5 py-1 rounded-lg border border-gray-100"><i class="fa-regular fa-clock text-[11px] mr-1.5"></i><span>${item.stay} ë¨¸ë­„</span></div>` : ''}
                                    ${item.memo ? `<p class="text-[13px] text-gray-600 bg-[#FAFAFA] p-3.5 rounded-xl leading-relaxed border-l-[3px] border-gray-200 pl-3">${item.memo}</p>` : ''}
                                </div>
                                <div class="flex gap-2 mt-4">
                                    ${item.flightUrl ? `
                                        <a href="${item.flightUrl}" target="_blank" class="flex-1 py-3 bg-blue-50 hover:bg-blue-100 rounded-xl text-[13px] font-bold text-blue-600 border border-blue-100 flex items-center justify-center gap-1.5 transition-all">
                                            <i class="fa-solid fa-external-link-alt text-[15px]"></i> ìš´í•­ì •ë³´
                                        </a>` : `
                                        <a href="${mapLink}" target="_blank" class="flex-1 py-3 bg-[#F2F4F6] hover:bg-[#E5E7EB] rounded-xl text-[13px] font-bold text-gray-600 hover:text-black border border-gray-200 flex items-center justify-center gap-1.5 transition-all">
                                            <i class="fa-solid fa-location-dot text-[15px]"></i> ì§€ë„
                                        </a>`}
                                </div>
                            </div>
                            ${item.move ? `<div class="flex items-center gap-2 mt-3 ml-2 animate-fade-in"><div class="w-1.5 h-1.5 bg-gray-300 rounded-full"></div><div class="text-[11px] font-semibold text-gray-400 flex items-center bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm"><i class="fa-solid fa-route text-[10px] mr-1.5"></i>${item.move}</div></div>` : ''}
                        </div>
                    </div>
                </div>`;
        };

        const renderSchedule = () => {
            const itemsHtml = scheduleData[currentDay].map((item, index) =>
                renderItineraryCard(item, index === scheduleData[currentDay].length - 1, index)
            ).join('');
            return `<div class="pb-10">${itemsHtml}<div class="mt-12 mb-6 text-center"><div class="w-16 h-1 bg-gray-200 rounded-full mx-auto mb-4"></div><p class="text-xs text-gray-400 font-medium">ì˜¤ëŠ˜ì˜ ì¼ì •ì€ ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤ ğŸŒ™</p></div></div>`;
        };

        const renderCurrencyConverter = () => {
            return `
                <div class="pt-2">
                    <div class="bg-white rounded-[32px] p-8 shadow-sm border border-gray-100 animate-fade-in">
                        <div class="flex items-center justify-between mb-8">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-money-bill text-emerald-500 text-xl"></i> í™˜ìœ¨ ê³„ì‚°ê¸°</h3>
                            <span class="text-[11px] font-bold bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-full">1 TWD â‰ˆ ${RATE} KRW</span>
                        </div>
                        <div class="space-y-6">
                            <div class="relative group">
                                <label class="block text-[11px] font-bold text-gray-400 mb-2 ml-1 uppercase">Taiwan Dollar</label>
                                <div class="flex items-center bg-gray-50 rounded-2xl p-5 border-2 border-transparent focus-within:border-emerald-500 focus-within:bg-white focus-within:shadow-md transition-all duration-300">
                                    <span class="text-gray-900 font-bold text-2xl w-12 border-r border-gray-200 mr-4">NT$</span>
                                    <input type="number" id="twd-input" oninput="handleTwdChange(this.value)" class="bg-transparent w-full outline-none text-3xl font-bold text-gray-900 text-right font-mono" placeholder="0" inputmode="decimal" />
                                </div>
                            </div>
                            <div class="flex justify-center -my-3 relative z-10"><div class="bg-white border border-gray-100 p-2.5 rounded-full shadow-md"><i class="fa-solid fa-right-left text-gray-400 text-sm"></i></div></div>
                            <div class="relative">
                                <label class="block text-[11px] font-bold text-gray-400 mb-2 ml-1 uppercase">Korean Won</label>
                                <div class="flex items-center bg-blue-50/30 rounded-2xl p-5 border-2 border-transparent">
                                    <span class="text-blue-600 font-bold text-2xl w-12 border-r border-blue-100 mr-4">â‚©</span>
                                    <input type="text" id="krw-input" readonly class="bg-transparent w-full outline-none text-3xl font-bold text-blue-600 text-right font-mono" placeholder="0" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAIChatTab = () => {
            const messagesHtml = messages.map((msg) => `
                <div class="flex ${msg.role === "user" ? "justify-end" : "justify-start"} animate-fade-in">
                    <div class="max-w-[80%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === "user" ? "bg-blue-600 text-white rounded-br-none" : "bg-white text-gray-800 rounded-bl-none border border-gray-100"}">
                        ${msg.text.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');

            const loadingIndicator = chatLoading ? `
                <div class="flex justify-start">
                    <div class="bg-white p-3 rounded-2xl rounded-bl-none border border-gray-100 shadow-sm flex items-center gap-2">
                        <i class="fa-solid fa-spinner fa-spin text-gray-400 text-sm"></i><span class="text-xs text-gray-400">ë‹µë³€ ì‘ì„± ì¤‘...</span>
                    </div>
                </div>` : '';

            return `
                <div class="pt-2">
                    <div class="flex flex-col h-[calc(100vh-180px)] bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-hidden animate-fade-in">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-white flex items-center gap-2 shadow-sm">
                            <div class="bg-white/20 p-2 rounded-full"><i class="fa-solid fa-robot text-white text-xl"></i></div>
                            <div><h3 class="font-bold text-sm">AI ì—¬í–‰ ë¹„ì„œ</h3><p class="text-[10px] opacity-80">Powered by OpenAI GPT-3.5</p></div>
                        </div>
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#F5F5F7]">${messagesHtml}${loadingIndicator}<div id="messages-end-ref"></div></div>
                        <div class="p-3 bg-white border-t border-gray-100">
                            <div class="flex items-center gap-2 bg-gray-50 rounded-full px-4 py-2 border border-gray-200 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                                <input type="text" id="chat-input" oninput="chatInput = this.value" onkeypress="if(event.key === 'Enter') handleSend(this.value)" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 bg-transparent outline-none text-sm text-gray-800 placeholder-gray-400" ${chatLoading ? 'disabled' : ''} />
                                <button id="send-button" onclick="handleSend(document.getElementById('chat-input').value)" class="p-2 bg-blue-600 rounded-full text-white hover:bg-blue-700 active:scale-95 transition-all disabled:opacity-50" ${chatLoading ? 'disabled' : ''}><i class="fa-solid fa-paper-plane text-base"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderWeatherWidget = (weatherData, forecastData) => {
            if (!weatherData) return `<div class="flex items-center justify-center h-64"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>`;
            
            const todayDate = new Date().toLocaleDateString("ko-KR", { month: "long", day: "numeric", weekday: "short" });
            const forecastHtml = forecastData.map(day => {
                const dateStr = new Date(day.date).toLocaleDateString("ko-KR", { month: "numeric", day: "numeric", weekday: "short" });
                const maxTemp = Math.round(day.max);
                const minTemp = Math.round(day.min);
                const icon = getWeatherIconHtml(day.code, "w-5 h-5");
                const desc = getWeatherDesc(day.code);
                
                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0 hover:bg-gray-50/50 rounded-lg px-2 transition-colors">
                        <span class="font-semibold text-gray-600 text-sm w-20">${dateStr}</span>
                        <div class="flex items-center gap-3 flex-1 justify-center"><div class="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full">${icon}</div><span class="text-xs font-medium text-gray-500 w-10 text-center">${desc}</span></div>
                        <div class="flex gap-4 font-mono font-bold w-24 justify-end text-sm"><span class="text-gray-800">${maxTemp}Â°</span><span class="text-gray-300">/</span><span class="text-gray-400">${minTemp}Â°</span></div>
                    </div>
                `;
            }).join('');

            return `
                <div class="pt-4 space-y-6 animate-fade-in">
                    <div class="bg-gradient-to-br from-[#4FACFE] to-[#00F2FE] rounded-[32px] p-7 text-white shadow-xl shadow-blue-200/50 relative overflow-hidden group transition-all hover:scale-[1.01]">
                        <div class="absolute -top-10 -right-10 opacity-20 animate-pulse">${getWeatherIconHtml(0, "w-48 h-48 text-white")}</div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start">
                                <div><h3 class="text-lg font-bold opacity-90 flex items-center gap-2"><i class="fa-solid fa-location-dot text-base"></i> íƒ€ì´ë² ì´</h3><p class="text-sm opacity-80 mt-0.5 font-medium">${todayDate}</p></div>
                                <span class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-[11px] font-bold shadow-inner">LIVE</span>
                            </div>
                            <div class="flex items-center justify-between mt-8 mb-4">
                                <div class="flex flex-col"><span class="text-7xl font-bold tracking-tighter drop-shadow-sm">${Math.round(weatherData.temperature_2m)}Â°</span><span class="text-xl font-semibold mt-1 ml-1 opacity-90">${getWeatherDesc(weatherData.weather_code)}</span></div>
                                <div class="flex flex-col items-center filter drop-shadow-lg transform group-hover:scale-110 transition-transform duration-500">${getWeatherIconHtml(weatherData.weather_code)}</div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mt-6">
                                <div class="bg-white/15 backdrop-blur-md rounded-2xl p-3 flex flex-col items-center border border-white/10"><i class="fa-solid fa-droplet text-base mb-1 opacity-90"></i><span class="text-[10px] opacity-80">ìŠµë„</span><span class="font-bold text-sm">${weatherData.relative_humidity_2m}%</span></div>
                                <div class="bg-white/15 backdrop-blur-md rounded-2xl p-3 flex flex-col items-center border border-white/10"><i class="fa-solid fa-wind text-base mb-1 opacity-90"></i><span class="text-[10px] opacity-80">ë°”ëŒ</span><span class="font-bold text-sm">${weatherData.wind_speed_10m}</span></div>
                                <div class="bg-white/15 backdrop-blur-md rounded-2xl p-3 flex flex-col items-center border border-white/10"><i class="fa-solid fa-umbrella text-base mb-1 opacity-90"></i><span class="text-[10px] opacity-80">ê°•ìˆ˜</span><span class="font-bold text-[10px] mt-0.5">í™•ì¸</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-[32px] p-6 shadow-sm border border-gray-100"><h4 class="text-xs font-bold text-gray-400 mb-5 flex items-center gap-2 uppercase tracking-wider"><i class="fa-regular fa-calendar-days text-sm"></i> ì£¼ê°„ ì˜ˆë³´</h4><div class="space-y-1">${forecastHtml}</div></div>
                </div>
            `;
        };

        // --- HANDLERS ---
        let twdInput, krwInput;

        const handleTwdChange = (val) => {
            const twd = parseFloat(val);
            const krw = val ? Math.round(twd * RATE).toLocaleString() : "";
            if (krwInput) krwInput.value = krw;
        };

        const handleSend = async (userText) => {
            if (!userText.trim() || chatLoading) return;
            
            const inputField = document.getElementById('chat-input');
            if(inputField) inputField.value = "";
            chatInput = "";

            messages.push({ role: "user", text: userText });
            chatLoading = true;
            renderApp();
            
            // Wait for DOM
            setTimeout(() => {
                const endRef = document.getElementById('messages-end-ref');
                if(endRef) endRef.scrollIntoView({ behavior: "smooth" });
            }, 50);

            const aiText = await getAIResponse(userText);
            
            messages.push({ role: "bot", text: aiText });
            chatLoading = false;
            renderApp();
            
            setTimeout(() => {
                const endRef = document.getElementById('messages-end-ref');
                if(endRef) endRef.scrollIntoView({ behavior: "smooth" });
                const input = document.getElementById('chat-input');
                if(input) input.focus();
            }, 50);
        };

        const setActiveTab = (tab) => { activeTab = tab; renderApp(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        const setCurrentDay = (day) => { currentDay = day; renderApp(); window.scrollTo({ top: 0, behavior: 'smooth' }); };

        // --- WEATHER LOGIC ---
        let weatherCache = null;
        const fetchWeatherData = async () => {
            try {
                const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=25.0330&longitude=121.5654&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei");
                const data = await res.json();
                const forecast = data.daily.time.slice(1, 6).map((time, i) => ({
                    date: time, code: data.daily.weather_code[i+1], max: data.daily.temperature_2m_max[i+1], min: data.daily.temperature_2m_min[i+1]
                }));
                weatherCache = { current: data.current, forecast: forecast };
                if (activeTab === 'weather') renderApp();
            } catch (error) { console.error("Weather fetch failed", error); }
        };

        // --- APP RENDER ---
        const updateDaySelector = () => {
            const daySelector = document.getElementById('day-selector');
            if (daySelector) {
                daySelector.innerHTML = Object.keys(scheduleData).map((day, i) => `
                    <button onclick="setCurrentDay('${day}')" class="flex-shrink-0 px-5 py-2.5 rounded-full text-[13px] font-bold transition-all duration-300 ${currentDay === day ? 'bg-gray-900 text-white shadow-lg shadow-gray-300/50 scale-[1.02]' : 'bg-white text-gray-400 shadow-sm border border-gray-100 hover:text-gray-600'}">Day ${i + 1}</button>
                `).join('');
            }
            const header = document.getElementById('main-header');
            const dayContainer = document.getElementById('day-selector-container');
            if (activeTab === "schedule") {
                dayContainer.classList.remove('hidden');
                header.classList.add('fixed-schedule');
            } else {
                dayContainer.classList.add('hidden');
                header.classList.remove('fixed-schedule');
            }
        };

        const updateBottomNav = () => {
            const nav = document.getElementById('bottom-nav-buttons');
            if(nav) {
                const tabs = [
                    { id: "schedule", label: "ì¼ì •", icon: "fa-route", color: "text-blue-600" },
                    { id: "ai_chat", label: "AI ë¹„ì„œ", icon: "fa-message", color: "text-violet-600" },
                    { id: "currency", label: "í™˜ìœ¨", icon: "fa-money-bill", color: "text-emerald-600" },
                    { id: "weather", label: "ë‚ ì”¨", icon: "fa-sun", color: "text-orange-500" },
                ];
                nav.innerHTML = tabs.map(tab => `
                    <button onclick="setActiveTab('${tab.id}')" class="flex-1 flex flex-col items-center gap-1 py-3 rounded-[20px] transition-all duration-300 ${activeTab === tab.id ? `bg-white shadow-sm ${tab.color} scale-[1.02]` : 'text-gray-400 hover:text-gray-600'}">
                        <i class="fa-solid ${tab.icon} text-xl"></i><span class="text-[10px] font-bold tracking-tight">${tab.label}</span>
                    </button>
                `).join('');
            }
        };

        const renderApp = () => {
            const mainContent = document.getElementById('main-content');
            if (!mainContent) return;
            
            if (activeTab === 'schedule') mainContent.innerHTML = renderSchedule();
            else if (activeTab === 'currency') {
                mainContent.innerHTML = renderCurrencyConverter();
                twdInput = document.getElementById('twd-input');
                krwInput = document.getElementById('krw-input');
                if (twdInput) twdInput.focus();
            }
            else if (activeTab === 'ai_chat') mainContent.innerHTML = renderAIChatTab();
            else if (activeTab === 'weather') {
                mainContent.innerHTML = !weatherCache ? renderWeatherWidget(null, null) : renderWeatherWidget(weatherCache.current, weatherCache.forecast);
                if (!weatherCache) fetchWeatherData();
            }
            updateDaySelector();
            updateBottomNav();
        };

        const handleScroll = () => {
            const header = document.getElementById('main-header');
            if (header) {
                header.className = window.scrollY > 10 
                    ? "fixed top-0 w-full z-50 transition-all duration-300 bg-white/80 backdrop-blur-xl shadow-sm pt-2 pb-2 border-b border-gray-200/50"
                    : "fixed top-0 w-full z-50 transition-all duration-300 bg-transparent pt-6 pb-2";
            }
        };

        // --- INIT ---
        window.onload = () => {
            renderApp();
            window.addEventListener('scroll', handleScroll);
            fetchWeatherData();
        };
    </script>
</body>
</html>
