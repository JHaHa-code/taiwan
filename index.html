<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taipei Travel Log</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Leaflet CSS (Free Map API) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'sans-serif'],
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            400: 'rgba(255, 255, 255, 0.4)',
                            500: 'rgba(255, 255, 255, 0.5)',
                            800: 'rgba(255, 255, 255, 0.8)',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.6s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                    }
                }
            }
        }
    </script>

    <style>
        /* Global & Utilities */
        :root {
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        body {
            background-color: #F2F2F7;
            -webkit-font-smoothing: antialiased;
            font-family: 'Inter', sans-serif;
        }
        
        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05);
        }

        /* Map Container */
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 1; }

        /* Dynamic Background Gradients */
        .theme-morning { background: linear-gradient(180deg, #E0F7FA 0%, #F2F2F7 40%); }
        .theme-day { background: linear-gradient(180deg, #FFF9C4 0%, #F2F2F7 40%); }
        .theme-sunset { background: linear-gradient(180deg, #FFECB3 0%, #F2F2F7 40%); }
        .theme-night { background: linear-gradient(180deg, #1a237e 0%, #050505 100%); color: #e0e0e0; }
        .theme-night .glass-card { background: rgba(30, 30, 40, 0.6); border-color: rgba(255,255,255,0.1); color: white; }
        .theme-night .text-gray-700 { color: #e0e0e0; }
        .theme-night .text-gray-800 { color: #ffffff; }
        .theme-night .bg-white { background-color: #1e1e24; color: white; }
        .theme-night .bg-gray-50 { background-color: #2c2c35; color: #e0e0e0; }

        /* Leaflet Fixes */
        .leaflet-control-attribution { font-size: 8px; opacity: 0.6; }
        
        /* Input Overflow Handling */
        .currency-input {
            background: transparent;
            text-align: right;
            font-weight: 700;
            outline: none;
            width: 100%;
            overflow-x: auto;
        }
    </style>
</head>
<body class="transition-colors duration-1000 pb-safe" id="main-body">

    <!-- Intro Overlay -->
    <div id="intro-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="text-center space-y-2 animate-slide-up">
            <div class="w-16 h-16 bg-blue-500 rounded-2xl flex items-center justify-center text-white text-3xl shadow-xl mx-auto mb-4">
                <i class="fa-solid fa-plane-up"></i>
            </div>
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Taipei Log</h1>
            <p class="text-sm text-gray-400">여행을 기록하다</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="max-w-xl mx-auto px-4 py-6 opacity-0 transition-opacity duration-700 flex flex-col min-h-screen">
        
        <!-- Hero Section -->
        <header class="relative w-full h-72 rounded-[2rem] overflow-hidden mb-6 shadow-2xl group shrink-0">
            <img src="https://images.unsplash.com/photo-1470004914212-05527e49370b?q=80&w=2674&auto=format&fit=crop" 
                 class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 scale-105 group-hover:scale-110"
                 alt="Taipei 101">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent"></div>
            
            <div class="absolute bottom-6 left-6 text-white z-10">
                <div class="flex items-center gap-2 mb-1 opacity-90">
                    <span class="text-xs font-semibold bg-white/20 backdrop-blur-md px-2 py-0.5 rounded-md border border-white/20">3박 4일</span>
                    <span class="text-xs font-medium">2025.12.18 - 12.21</span>
                </div>
                <h2 class="text-3xl font-bold tracking-tight drop-shadow-sm">Taipei, Taiwan</h2>
            </div>
        </header>

        <!-- Dashboard Grid (Bento Box Style) -->
        <div class="grid grid-cols-2 gap-3 mb-8 shrink-0">
            
            <!-- 1. Weather Card (Open-Meteo API) -->
            <div class="glass-card p-4 rounded-3xl col-span-2 md:col-span-1 relative overflow-hidden active:scale-95 transition-transform cursor-pointer" onclick="openWeatherDetail()">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="fa-solid fa-cloud text-6xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Weather</span>
                        <i class="fa-solid fa-location-arrow text-xs text-blue-500"></i>
                    </div>
                    <div class="flex items-end gap-2">
                        <span id="weather-temp" class="text-4xl font-bold text-gray-800">--°</span>
                        <div class="mb-1">
                            <p id="weather-desc" class="text-sm font-medium text-gray-600 leading-tight">Loading...</p>
                            <p class="text-xs text-gray-400">H:<span id="temp-max">-</span> L:<span id="temp-min">-</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Time Card (WorldTime API) -->
            <!-- col-span-2 클래스를 추가하여 모바일에서 가로 전체를 차지하게 변경했습니다 (PC에서는 md:col-span-1로 절반 유지) -->
            <div class="glass-card p-4 rounded-3xl col-span-2 md:col-span-1 flex flex-col justify-between relative overflow-hidden">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Time</span>
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-baseline border-b border-gray-200/50 pb-1">
                        <span class="text-xs text-gray-400">Seoul</span>
                        <span id="time-seoul" class="text-lg font-bold text-gray-700 font-mono">--:--</span>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs text-blue-500 font-bold">Taipei</span>
                        <span id="time-taipei" class="text-2xl font-bold text-blue-600 font-mono">--:--</span>
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 text-right mt-1">-1시간 차이</p>
            </div>

            <!-- 3. Exchange Rate (ExchangeRate-API) -->
            <div class="glass-card p-4 rounded-3xl col-span-2 cursor-pointer active:scale-95 transition-transform" onclick="toggleCurrency()">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block mb-1">Exchange Rate</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-2xl font-bold text-gray-800">100 <span class="text-sm font-medium text-gray-400">TWD</span></span>
                            <i class="fa-solid fa-arrow-right text-gray-300 text-xs"></i>
                            <span class="text-2xl font-bold text-blue-600"><span id="dash-krw">--</span> <span class="text-sm font-medium text-blue-400">KRW</span></span>
                        </div>
                    </div>
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center">
                        <i class="fa-solid fa-calculator"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Day Selector (Sticky) -->
        <div class="sticky top-4 z-30 mb-6 shrink-0">
            <div class="bg-white/80 backdrop-blur-xl rounded-2xl p-1.5 flex justify-between shadow-lg shadow-gray-200/50 border border-white/50 overflow-x-auto no-scrollbar" id="day-tabs">
                <!-- JS Injected -->
            </div>
        </div>

        <!-- Timeline -->
        <div id="timeline-container" class="space-y-6 flex-1">
            <!-- JS Injected -->
        </div>

        <!-- Footer -->
        <footer class="mt-12 pb-8 text-center shrink-0">
            <p class="text-[10px] text-gray-400 font-medium tracking-wide opacity-70">© 2025 Bae Jae Hyun. All Rights Reserved.</p>
        </footer>

    </div>

    <!-- Floating Action Button (To Top) -->
    <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="fixed bottom-6 right-6 w-12 h-12 bg-black text-white rounded-full shadow-2xl z-40 flex items-center justify-center text-lg active:scale-90 transition-transform opacity-80 hover:opacity-100">
        <i class="fa-solid fa-arrow-up"></i>
    </button>

    <!-- ================= MODALS ================= -->

    <!-- 1. Weather Modal -->
    <div id="weather-modal" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden items-end sm:items-center justify-center transition-all duration-300 opacity-0" onclick="closeWeatherDetail()">
        <div class="bg-white/90 backdrop-blur-xl w-full sm:w-[28rem] rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300 max-h-[85vh] overflow-hidden flex flex-col" id="weather-content" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mt-3 mb-2 sm:hidden"></div>
            
            <div class="p-6 pb-0">
                <h3 class="text-2xl font-bold text-gray-800">Hourly Forecast</h3>
                <p class="text-sm text-gray-500 mb-4">앞으로 24시간의 날씨 변화</p>
            </div>

            <!-- Horizontal Scroll -->
            <div class="overflow-x-auto no-scrollbar px-6 pb-6">
                <div class="flex gap-3" id="hourly-container">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- Daily List -->
            <div class="flex-1 overflow-y-auto px-6 pb-8 bg-gray-50/50 border-t border-gray-100 pt-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase mb-3">Weekly Forecast</h4>
                <div class="space-y-2" id="daily-container">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Currency Modal -->
    <div id="currency-modal" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm hidden items-end sm:items-center justify-center transition-all duration-300 opacity-0" onclick="closeCurrency()">
        <div class="bg-white w-full sm:w-[24rem] rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300 overflow-hidden" id="currency-content" onclick="event.stopPropagation()">
            <div class="bg-gray-50 p-6 border-b border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">환율 계산기</h3>
                    <button onclick="closeCurrency()" class="w-8 h-8 bg-gray-200 rounded-full text-gray-500 hover:bg-gray-300 transition-colors"><i class="fa-solid fa-xmark"></i></button>
                </div>
                
                <!-- Inputs with Swap Button -->
                <div class="space-y-3 relative">
                    <!-- TWD Input -->
                    <div class="bg-white border-2 border-blue-500 rounded-2xl p-4 flex items-center shadow-sm transition-colors overflow-hidden" id="input-wrap-twd" onclick="setActiveCurrency('TWD')">
                        <span class="text-sm font-bold text-gray-500 w-12 shrink-0">TWD</span>
                        <input type="text" id="input-twd" class="currency-input text-2xl text-gray-800" value="0" readonly>
                    </div>

                    <!-- Swap Button -->
                    <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20">
                        <button onclick="swapCurrencyMode(event)" class="w-10 h-10 bg-white border border-gray-200 shadow-lg rounded-full flex items-center justify-center text-blue-600 hover:scale-110 active:scale-95 transition-transform">
                            <i class="fa-solid fa-arrow-right-arrow-left text-sm"></i>
                        </button>
                    </div>

                    <!-- KRW Input -->
                    <div class="bg-white border-2 border-transparent rounded-2xl p-4 flex items-center shadow-sm transition-colors overflow-hidden" id="input-wrap-krw" onclick="setActiveCurrency('KRW')">
                        <span class="text-sm font-bold text-gray-500 w-12 shrink-0">KRW</span>
                        <input type="text" id="input-krw" class="currency-input text-2xl text-gray-800" value="0" readonly>
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 text-right mt-2">환율: 1 TWD ≈ <span id="modal-rate">--</span> KRW</p>
            </div>

            <!-- Numpad -->
            <div class="grid grid-cols-3 bg-white p-2 gap-[1px] bg-gray-100">
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="1">1</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="2">2</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="3">3</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="4">4</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="5">5</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="6">6</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="7">7</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="8">8</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="9">9</button>
                <button class="bg-white p-5 text-xl font-medium text-red-500 active:bg-red-50" onclick="clearCalc()">C</button>
                <button class="bg-white p-5 text-xl font-medium active:bg-gray-50 num-btn" data-val="0">0</button>
                <button class="bg-white p-5 text-xl font-medium text-gray-600 active:bg-gray-50" onclick="backspaceCalc()"><i class="fa-solid fa-delete-left"></i></button>
            </div>
        </div>
    </div>

    <!-- 3. Detail & Map Modal (Leaflet API) -->
    <div id="detail-modal" class="fixed inset-0 z-[70] bg-black/50 backdrop-blur-md hidden items-end sm:items-center justify-center transition-all duration-300 opacity-0" onclick="closeDetail()">
        <div class="bg-white w-full sm:w-[26rem] h-[90vh] sm:h-[40rem] rounded-t-[2rem] sm:rounded-[2rem] shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300 flex flex-col overflow-hidden" id="detail-content" onclick="event.stopPropagation()">
            
            <!-- Map Area -->
            <div class="relative h-1/2 w-full bg-gray-100">
                <div id="map"></div> <!-- Leaflet Map container -->
                <button onclick="closeDetail()" class="absolute top-4 right-4 z-[400] w-8 h-8 bg-white/80 backdrop-blur rounded-full shadow-md flex items-center justify-center text-gray-800">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <!-- Info Area -->
            <div class="flex-1 bg-white p-6 overflow-y-auto relative -mt-4 rounded-t-[2rem] z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <div class="w-10 h-1 bg-gray-200 rounded-full mx-auto mb-4"></div>
                
                <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded-md uppercase tracking-wider" id="detail-category">Category</span>
                <h2 class="text-2xl font-bold text-gray-900 mt-2 leading-tight" id="detail-title">Place Name</h2>
                <p class="text-sm text-gray-500 mt-1 flex items-center gap-1">
                    <i class="fa-solid fa-map-pin text-red-400"></i> <span id="detail-mapname">Address</span>
                </p>

                <div class="grid grid-cols-2 gap-3 my-6">
                    <div class="bg-gray-50 p-3 rounded-2xl text-center">
                        <span class="text-xs text-gray-400 block">Arrival</span>
                        <span class="font-bold text-gray-800 text-lg" id="detail-arrive">--:--</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-2xl text-center">
                        <span class="text-xs text-gray-400 block">Stay</span>
                        <span class="font-bold text-gray-800 text-lg" id="detail-stay">-</span>
                    </div>
                </div>

                <div class="bg-yellow-50 border border-yellow-100 p-4 rounded-2xl mb-4 hidden" id="detail-memo-box">
                    <h5 class="text-xs font-bold text-yellow-700 mb-1 flex items-center"><i class="fa-solid fa-sticky-note mr-1.5"></i> Memo</h5>
                    <p class="text-sm text-gray-700 leading-relaxed" id="detail-memo">Content</p>
                </div>

                <div class="bg-gray-50 p-4 rounded-2xl flex items-center gap-3 hidden" id="detail-move-box">
                    <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center text-blue-500">
                        <i class="fa-solid fa-person-walking"></i>
                    </div>
                    <div>
                        <span class="text-xs text-gray-400 block">Next Move</span>
                        <span class="text-sm font-bold text-gray-700" id="detail-move">Walk</span>
                    </div>
                </div>
                
                <!-- Google Maps Button (NEW) -->
                <div id="google-maps-btn-container" class="mt-6">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        // --- 1. DATA (Enhanced with Coordinates for Map API) ---
        // User's full data structure with added 'coords' for the map functionality.
        const travelData = {
            "Day1": [
                { "place": "김해국제공항 (에어부산 카운터 D동, Gate5 2층)", "map": "金海國際機場", "arrive": "08:50", "stay": "2h", "depart": "-", "category": "출국", "memo": "수속 및 대기", "move": null, "coords": [35.1796, 128.9382] },
                { "place": "에어부산 BX793 (PUS 10:50 - TPE 12:25)", "arrive": "10:50", "depart": "12:25", "category": "비행", "stay": "2h 35m", "map": "桃園國際機場", "move": "비행", "coords": [25.0797, 121.2342] },
                { "place": "타오위안 국제공항", "map": "桃園國際機場", "arrive": "12:25", "stay": "-", "depart": "-", "category": "입국", "memo": "입국심사, MRT 탑승", "move": "MRT 40m", "coords": [25.0797, 121.2342] },
                { "place": "타이베이 메인 스테이션", "map": "台北車站", "category": "교통", "memo": "숙소 인근 도착", "move": "도보 10m", "coords": [25.0478, 121.5170] },
                { "place": "유산동 우육면", "map": "山東牛肉麵 西門店", "category": "음식점", "memo": "중식", "move": "도보 10m", "coords": [25.0462, 121.5145] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "15:00", "stay": "30m", "depart": "15:30", "category": "숙소", "memo": "체크인 및 휴식", "move": "도보 10m", "coords": [25.0429, 121.5089] },
                { "place": "삼형매 빙수", "map": "三兄妹豆花冰品", "arrive": "15:40", "stay": "50m", "depart": "16:30", "category": "디저트", "memo": "디저트", "move": "전철 20m", "coords": [25.0435, 121.5075] },
                { "place": "국립 중정 기념당", "map": "國立中正紀念堂", "arrive": "16:50", "stay": "1h 10m", "depart": "18:00", "category": "관광명소", "move": "전철 30m", "coords": [25.0354, 121.5197] },
                { "place": "스린 야시장", "map": "士林夜市", "arrive": "18:30", "stay": "3h", "depart": "21:30", "category": "야시장", "memo": "야시장", "move": "전철 30m", "coords": [25.0880, 121.5247] },
                { "place": "스위엔 시먼점", "map": "師園鹽酥雞（西門店）", "arrive": "22:00", "category": "음식점", "memo": "야식", "move": "도보 5m", "coords": [25.0430, 121.5070] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "취침", "coords": [25.0429, 121.5089] }
            ],
            "Day2": [
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "조식 & 준비", "move": "도보 5m", "coords": [25.0429, 121.5089] },
                { "place": "시먼역 (4번 출구)", "map": "捷運西門站 4號出口", "arrive": "10:45", "category": "교통", "memo": "가이드 미팅", "move": "버스 이동", "coords": [25.0422, 121.5082] },
                { "place": "예류 지질공원", "map": "野柳地質公園", "arrive": "12:30", "stay": "1h 10m", "depart": "13:40", "category": "관광명소", "coords": [25.2064, 121.6905] },
                { "place": "스펀 폭포", "map": "十分瀑布", "arrive": "14:40", "stay": "50m", "depart": "15:30", "category": "관광명소", "coords": [25.0493, 121.7878] },
                { "place": "스펀 라오제", "map": "十分老街", "arrive": "15:40", "stay": "50m", "depart": "16:30", "category": "관광명소", "memo": "천등 체험", "coords": [25.0426, 121.7766] },
                { "place": "지우펀", "map": "九份老街", "arrive": "17:10", "stay": "2h", "depart": "19:10", "category": "관광명소", "memo": "석식", "move": "버스 이동", "coords": [25.1099, 121.8452] },
                { "place": "시먼역", "arrive": "20:20", "map": "捷運西門站 4號出口", "category": "교통", "memo": "투어 종료", "move": "도보 5m", "coords": [25.0422, 121.5082] },
                { "place": "행복당 시먼점", "map": "幸福堂 西門店", "category": "디저트", "memo": "디저트", "move": "도보 10m", "coords": [25.0437, 121.5076] },
                { "place": "180도씨 지파이", "map": "180度C雞排", "category": "음식점", "memo": "야식", "move": "도보 15m", "coords": [25.0432, 121.5055] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "휴식", "coords": [25.0429, 121.5089] }
            ],
            "Day3": [
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "출발 준비", "move": "도보 5m", "coords": [25.0429, 121.5089] },
                { "place": "시먼딩", "map": "西門町", "arrive": "11:00", "stay": "1h 30m", "depart": "12:30", "category": "쇼핑", "coords": [25.0449, 121.5067] },
                { "place": "천천리", "map": "108台北市萬華區漢中街32巷1號", "arrive": "12:30", "stay": "1h", "depart": "13:30", "category": "음식점", "move": "버스 10m", "coords": [25.0445, 121.5072] },
                { "place": "까르푸 꾸이린점", "map": "家樂福 桂林店", "arrive": "13:40", "stay": "1h 30m", "depart": "15:10", "category": "쇼핑", "move": "도보 10m", "coords": [25.0383, 121.5062] },
                { "place": "세인트 피터 누가 크래커", "map": "聖比德 西門店", "arrive": "15:20", "stay": "20m", "depart": "15:40", "category": "쇼핑", "move": "도보 5m", "coords": [25.0439, 121.5080] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "15:45", "stay": "30m", "depart": "16:15", "category": "숙소", "memo": "물품 정리", "move": "전철 30m", "coords": [25.0429, 121.5089] },
                { "place": "딘타이펑 타이베이 101점", "map": "鼎泰豐 台北101店", "arrive": "16:45", "stay": "1h", "depart": "18:45", "category": "음식점", "memo": "대기 & 석식", "move": "101몰 내부 이동", "coords": [25.0336, 121.5648] },
                { "place": "타이베이 101 전망대", "map": "台北101 觀景台", "arrive": "19:00", "stay": "2h", "depart": "21:00", "category": "관광명소", "move": "버스 20m", "coords": [25.0339, 121.5644] },
                { "place": "레인보우 브리지", "map": "彩虹橋", "arrive": "21:20", "stay": "30m", "depart": "21:50", "category": "관광명소", "move": "전철 30m", "coords": [25.0518, 121.5784] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "22:20", "category": "숙소", "coords": [25.0429, 121.5089] }
            ],
            "Day4": [
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "category": "숙소", "memo": "조식 후 체크아웃", "move": "전철 30m", "coords": [25.0429, 121.5089] },
                { "place": "국립 대만대학교", "map": "國立臺灣大學", "arrive": "10:00", "stay": "1h 30m", "depart": "11:30", "category": "관광명소", "memo": "캠퍼스", "move": "전철 30m", "coords": [25.0173, 121.5398] },
                { "place": "용산사", "map": "龍山寺", "arrive": "12:00", "stay": "1h", "depart": "13:00", "category": "사찰", "move": "도보 10m", "coords": [25.0368, 121.4999] },
                { "place": "삼미 식당", "map": "三味食堂", "arrive": "13:10", "stay": "1h", "depart": "14:10", "category": "음식점", "move": "버스 10m", "coords": [25.0405, 121.5031] },
                { "place": "호텔 미드타운 리처드슨", "map": "德立莊酒店", "arrive": "14:20", "stay": "10m", "depart": "14:30", "category": "숙소", "memo": "짐 찾기", "move": "전철 10m", "coords": [25.0429, 121.5089] },
                { "place": "타이베이 메인 스테이션", "map": "台北車站", "arrive": "14:40", "category": "교통", "memo": "공항 MRT 대기", "move": "MRT 40m", "coords": [25.0478, 121.5170] },
                { "place": "타오위안 국제공항 (터미널 2)", "map": "桃園國際機場 第二航廈", "arrive": "15:30", "stay": "2h 10m", "category": "출국", "memo": "출국 수속", "coords": [25.0797, 121.2342] },
                { "place": "에어부산 BX792 (TPE 17:40 - PUS 21:00)", "arrive": "17:40", "depart": "21:00", "category": "비행", "map": "桃園國際機場 → 金海國際機場", "stay": "1h 45m", "memo": "귀국편", "coords": [35.1796, 128.9382] }
            ]
        };

        // --- 2. STATE ---
        let currentDay = 'Day1';
        let exchangeRate = 46.90; // Fallback
        let weatherData = null;
        let mapInstance = null;
        let activeCalcCurrency = 'TWD';
        let calcValue = "0";

        // --- 3. INITIALIZATION ---
        window.onload = async () => {
            // Intro Animation
            setTimeout(() => {
                document.getElementById('intro-screen').style.opacity = '0';
                document.getElementById('intro-screen').style.pointerEvents = 'none';
                document.getElementById('app').style.opacity = '1';
                
                // Load APIs & Render
                initTheme();
                renderTabs();
                renderTimeline('Day1');
                fetchWeather();
                fetchExchangeRate();
                initWorldTime(); // New API Feature
            }, 1500);
        };

        // Theme Logic
        function initTheme() {
            const hour = new Date().getHours();
            const body = document.getElementById('main-body');
            
            body.classList.remove('theme-morning', 'theme-day', 'theme-sunset', 'theme-night');
            if (hour >= 5 && hour < 11) body.classList.add('theme-morning');
            else if (hour >= 11 && hour < 17) body.classList.add('theme-day');
            else if (hour >= 17 && hour < 20) body.classList.add('theme-sunset');
            else body.classList.add('theme-night');
        }

        // --- 4. API: WORLD TIME ---
        function initWorldTime() {
            const updateClock = () => {
                const now = new Date();
                
                // Seoul Time
                const seoulTime = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: false, 
                    timeZone: 'Asia/Seoul' 
                });
                
                // Taipei Time
                const taipeiTime = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: false, 
                    timeZone: 'Asia/Taipei' 
                });

                document.getElementById('time-seoul').innerText = seoulTime;
                document.getElementById('time-taipei').innerText = taipeiTime;
            };
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        // --- 5. API: WEATHER (Open-Meteo) ---
        async function fetchWeather() {
            const lat = 25.0330; 
            const lon = 121.5654;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTaipei`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                weatherData = data;
                
                // Update Dashboard Widget
                const current = data.current_weather;
                const today = data.daily;
                
                document.getElementById('weather-temp').innerText = Math.round(current.temperature) + "°";
                document.getElementById('weather-desc').innerText = getWmoDesc(current.weathercode).desc;
                document.getElementById('temp-max').innerText = Math.round(today.temperature_2m_max[0]) + "°";
                document.getElementById('temp-min').innerText = Math.round(today.temperature_2m_min[0]) + "°";
            } catch (e) {
                console.error("Weather Error", e);
                document.getElementById('weather-desc').innerText = "Offline";
            }
        }

        function getWmoDesc(code) {
            const map = {
                0: { desc: "맑음", icon: "fa-sun", color: "text-yellow-500" },
                1: { desc: "대체로 맑음", icon: "fa-cloud-sun", color: "text-orange-400" },
                2: { desc: "구름 많음", icon: "fa-cloud", color: "text-gray-400" },
                3: { desc: "흐림", icon: "fa-smog", color: "text-gray-500" },
                45: { desc: "안개", icon: "fa-water", color: "text-blue-300" },
                61: { desc: "비", icon: "fa-cloud-rain", color: "text-blue-500" },
                80: { desc: "소나기", icon: "fa-cloud-showers-heavy", color: "text-blue-600" },
                95: { desc: "뇌우", icon: "fa-bolt", color: "text-purple-500" }
            };
            return map[code] || { desc: "흐림", icon: "fa-cloud", color: "text-gray-400" };
        }

        // --- 6. API: EXCHANGE RATE ---
        async function fetchExchangeRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/TWD');
                const data = await res.json();
                if(data.rates && data.rates.KRW) {
                    exchangeRate = data.rates.KRW;
                }
            } catch (e) { console.warn("Exchange API Error, using fallback"); }
            
            // Update Dashboard
            document.getElementById('dash-krw').innerText = Math.round(100 * exchangeRate).toLocaleString();
            document.getElementById('modal-rate').innerText = exchangeRate.toFixed(2);
        }

        // --- 7. RENDER LOGIC ---
        function renderTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = Object.keys(travelData).map(day => `
                <button onclick="switchDay('${day}')" 
                    class="px-5 py-2 rounded-xl text-sm font-bold transition-all duration-300 whitespace-nowrap ${currentDay === day ? 'bg-black text-white shadow-lg transform scale-105' : 'text-gray-400 hover:bg-white/50'}">
                    ${day}
                </button>
            `).join('');
        }

        function switchDay(day) {
            currentDay = day;
            renderTabs();
            const timeline = document.getElementById('timeline-container');
            timeline.style.opacity = '0';
            timeline.style.transform = 'translateY(10px)';
            setTimeout(() => {
                renderTimeline(day);
                timeline.style.opacity = '1';
                timeline.style.transform = 'translateY(0)';
            }, 200);
        }

        function renderTimeline(day) {
            const list = travelData[day];
            const container = document.getElementById('timeline-container');
            
            container.innerHTML = list.map((item, idx) => {
                const icon = getCategoryIcon(item.category);
                
                // 1. Arrival & Depart Time
                let timeHTML = `<span class="text-sm font-bold text-gray-800 dark:text-gray-200">${item.arrive || (item.category === '숙소' ? '' : '--:--')}</span>`;

                // 2. Card Internal Details (Stay, Depart, Move)
                const stayInfo = item.stay ? 
                    `<span class="flex items-center gap-1 bg-white/50 px-2 py-0.5 rounded text-gray-600"><i class="fa-regular fa-clock text-[10px]"></i> ${item.stay} 체류</span>` : '';
                
                const departInfo = item.depart && item.depart !== '-' ? 
                    `<span class="flex items-center gap-1 bg-red-50 text-red-600 px-2 py-0.5 rounded"><i class="fa-solid fa-arrow-right-from-bracket text-[10px]"></i> ${item.depart} 출발</span>` : '';
                
                const moveInfo = item.move ? 
                    `<div class="mt-2 text-xs font-medium text-blue-600 flex items-center gap-1.5 border-t border-gray-100 pt-2">
                        <i class="fa-solid fa-route"></i> 
                        <span>이동: ${item.move}</span>
                     </div>` : '';

                return `
                <div class="flex gap-4 group animate-slide-up cursor-pointer" style="animation-delay: ${idx * 50}ms" onclick="openDetail('${day}', ${idx})">
                    <!-- Left: Time Column -->
                    <div class="flex flex-col items-center w-14 pt-1 shrink-0">
                        ${timeHTML}
                        <div class="h-full w-0.5 bg-gray-200 my-2 group-hover:bg-blue-300 transition-colors relative">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-2.5 h-2.5 rounded-full bg-white border-2 border-blue-500 z-10"></div>
                        </div>
                    </div>

                    <!-- Right: Card -->
                    <div class="flex-1 pb-6">
                        <div class="glass-card p-4 rounded-2xl hover:bg-white/90 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg border-l-4 border-l-blue-500/50">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <span class="inline-block text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded mb-1">${item.category}</span>
                                    <h3 class="font-bold text-gray-800 text-lg leading-tight">${item.place}</h3>
                                </div>
                                <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                            </div>

                            <!-- Detailed Timeline Info (Stay & Depart) -->
                            ${(stayInfo || departInfo) ? `<div class="flex flex-wrap gap-2 text-xs font-medium mb-1">${stayInfo}${departInfo}</div>` : ''}
                            
                            <p class="text-xs text-gray-500 mt-1 line-clamp-1">${item.memo || ''}</p>

                            <!-- Next Move Info -->
                            ${moveInfo}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function getCategoryIcon(cat) {
            if(cat.includes('공항') || cat.includes('출국') || cat.includes('입국') || cat.includes('비행')) return 'fa-plane';
            if(cat.includes('식당') || cat.includes('음식')) return 'fa-utensils';
            if(cat.includes('숙소')) return 'fa-bed';
            if(cat.includes('쇼핑')) return 'fa-bag-shopping';
            if(cat.includes('관광')) return 'fa-camera';
            if(cat.includes('디저트')) return 'fa-ice-cream';
            if(cat.includes('교통')) return 'fa-bus';
            if(cat.includes('사찰')) return 'fa-place-of-worship';
            return 'fa-location-dot';
        }

        // --- 8. UI INTERACTIONS (MODALS) ---

        // WEATHER MODAL
        function openWeatherDetail() {
            if(!weatherData) return;
            const modal = document.getElementById('weather-modal');
            const content = document.getElementById('weather-content');
            
            // Render Hourly
            const hourlyHTML = weatherData.hourly.time.slice(0, 24).map((t, i) => {
                const date = new Date(t);
                const hour = date.getHours();
                const temp = Math.round(weatherData.hourly.temperature_2m[i]);
                const info = getWmoDesc(weatherData.hourly.weathercode[i]);
                return `
                    <div class="flex flex-col items-center min-w-[60px] bg-gray-50 p-3 rounded-2xl">
                        <span class="text-xs text-gray-400 mb-2">${hour}시</span>
                        <i class="fa-solid ${info.icon} ${info.color} text-xl mb-2"></i>
                        <span class="text-sm font-bold text-gray-800">${temp}°</span>
                    </div>
                `;
            }).join('');
            document.getElementById('hourly-container').innerHTML = hourlyHTML;

            // Render Daily
            const dailyHTML = weatherData.daily.time.map((t, i) => {
                const date = new Date(t);
                const dayName = date.toLocaleDateString('ko-KR', { weekday: 'short' });
                const min = Math.round(weatherData.daily.temperature_2m_min[i]);
                const max = Math.round(weatherData.daily.temperature_2m_max[i]);
                const info = getWmoDesc(weatherData.daily.weathercode[i]);
                return `
                    <div class="flex items-center justify-between p-3 hover:bg-white rounded-xl transition-colors">
                        <span class="w-10 font-bold text-gray-600">${i===0?'오늘':dayName}</span>
                        <div class="flex items-center gap-2 flex-1 justify-center">
                            <i class="fa-solid ${info.icon} ${info.color}"></i>
                            <span class="text-xs text-gray-500">${info.desc}</span>
                        </div>
                        <div class="flex gap-3 text-sm font-medium">
                            <span class="text-gray-400">${min}°</span>
                            <span class="text-gray-800">${max}°</span>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('daily-container').innerHTML = dailyHTML;

            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
        }

        function closeWeatherDetail() {
            const modal = document.getElementById('weather-modal');
            document.getElementById('weather-content').classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // CURRENCY MODAL
        function toggleCurrency() {
            const modal = document.getElementById('currency-modal');
            const content = document.getElementById('currency-content');
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
            updateCalcUI();
        }

        function closeCurrency() {
            const modal = document.getElementById('currency-modal');
            document.getElementById('currency-content').classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function setActiveCurrency(curr) {
            activeCalcCurrency = curr;
            calcValue = "0"; 
            updateCalcUI();
        }
        
        function swapCurrencyMode(e) {
            e.stopPropagation(); // Prevent triggering parent onclick
            activeCalcCurrency = (activeCalcCurrency === 'TWD') ? 'KRW' : 'TWD';
            calcValue = "0";
            updateCalcUI();
        }

        function updateCalcUI() {
            const twdWrap = document.getElementById('input-wrap-twd');
            const krwWrap = document.getElementById('input-wrap-krw');
            
            // Reset borders and colors
            if(activeCalcCurrency === 'TWD') {
                twdWrap.classList.replace('border-transparent', 'border-blue-500');
                twdWrap.classList.replace('bg-white', 'bg-blue-50');
                krwWrap.classList.replace('border-blue-500', 'border-transparent');
                krwWrap.classList.replace('bg-blue-50', 'bg-white');
            } else {
                krwWrap.classList.replace('border-transparent', 'border-blue-500');
                krwWrap.classList.replace('bg-white', 'bg-blue-50');
                twdWrap.classList.replace('border-blue-500', 'border-transparent');
                twdWrap.classList.replace('bg-blue-50', 'bg-white');
            }
            calculate();
        }

        // Calc Logic
        document.querySelectorAll('.num-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const val = e.target.getAttribute('data-val');
                if(calcValue === '0') calcValue = val;
                else if(calcValue.length < 10) calcValue += val; // Limit length to prevent huge overflow
                calculate();
            });
        });

        function backspaceCalc() {
            if(calcValue.length > 1) calcValue = calcValue.slice(0, -1);
            else calcValue = '0';
            calculate();
        }
        function clearCalc() {
            calcValue = '0';
            calculate();
        }

        function calculate() {
            const twdInput = document.getElementById('input-twd');
            const krwInput = document.getElementById('input-krw');
            const num = parseInt(calcValue);

            if(activeCalcCurrency === 'TWD') {
                twdInput.value = num.toLocaleString();
                krwInput.value = Math.round(num * exchangeRate).toLocaleString();
            } else {
                krwInput.value = num.toLocaleString();
                twdInput.value = Math.round(num / exchangeRate).toLocaleString();
            }
        }

        // --- 9. DETAIL MODAL WITH MAP API (Leaflet) ---
        function openDetail(day, idx) {
            const item = travelData[day][idx];
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');

            // Fill Text Info
            document.getElementById('detail-category').innerText = item.category;
            document.getElementById('detail-title').innerText = item.place;
            document.getElementById('detail-mapname').innerText = item.map;
            document.getElementById('detail-arrive').innerText = item.arrive || '--:--';
            document.getElementById('detail-stay').innerText = item.stay || '-';
            
            // Memo
            const memoBox = document.getElementById('detail-memo-box');
            if(item.memo) {
                memoBox.classList.remove('hidden');
                document.getElementById('detail-memo').innerText = item.memo;
            } else {
                memoBox.classList.add('hidden');
            }

            // Move Info
            const moveBox = document.getElementById('detail-move-box');
            if(item.move) {
                moveBox.classList.remove('hidden');
                document.getElementById('detail-move').innerText = item.move;
            } else {
                moveBox.classList.add('hidden');
            }

            // Add Google Maps Button
            const googleUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.map)}`;
            const btnContainer = document.getElementById('google-maps-btn-container');
            
            btnContainer.innerHTML = `
                <a href="${googleUrl}" target="_blank" class="w-full bg-white border border-gray-200 shadow-sm rounded-xl py-4 px-4 flex items-center justify-center gap-3 hover:bg-gray-50 active:scale-95 transition-all group">
                    <div class="w-8 h-8 bg-red-50 rounded-full flex items-center justify-center text-red-500 group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-diamond-turn-right"></i>
                    </div>
                    <span class="text-gray-700 font-bold">Google Maps 길찾기</span>
                </a>
            `;

            // Show Modal
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('flex');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);

            // Initialize Map (Leaflet)
            setTimeout(() => {
                if(mapInstance) {
                    mapInstance.remove(); // Reset previous map
                }
                
                // Default coords if missing (Taipei 101)
                const coords = item.coords || [25.0339, 121.5644]; 

                mapInstance = L.map('map').setView(coords, 15);

                // Add OpenStreetMap Tile Layer (Free API)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(mapInstance);

                // Add Marker
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:#3B82F6; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 4px 6px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                L.marker(coords, {icon: customIcon}).addTo(mapInstance)
                    .bindPopup(`<b>${item.place}</b><br>${item.map}`)
                    .openPopup();
                    
                mapInstance.invalidateSize(); 
            }, 300);
        }

        function closeDetail() {
            const modal = document.getElementById('detail-modal');
            document.getElementById('detail-content').classList.add('translate-y-full');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    </script>
</body>
</html>
